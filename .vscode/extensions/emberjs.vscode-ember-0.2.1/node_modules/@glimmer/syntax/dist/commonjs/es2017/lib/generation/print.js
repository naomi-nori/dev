'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.default = build;

var _nodes = require('../types/nodes');

var HBS = _interopRequireWildcard(_nodes);

var _tokenizerEventHandlers = require('../parser/tokenizer-event-handlers');

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

function unreachable() {
    throw new Error('unreachable');
}
function build(ast) {
    if (!ast) {
        return '';
    }
    const output = [];
    switch (ast.type) {
        case 'Program':
            {
                const chainBlock = ast['chained'] && ast.body[0];
                if (chainBlock) {
                    chainBlock['chained'] = true;
                }
                const body = buildEach(ast.body).join('');
                output.push(body);
            }
            break;
        case 'ElementNode':
            output.push('<', ast.tag);
            if (ast.attributes.length) {
                output.push(' ', buildEach(ast.attributes).join(' '));
            }
            if (ast.modifiers.length) {
                output.push(' ', buildEach(ast.modifiers).join(' '));
            }
            if (ast.comments.length) {
                output.push(' ', buildEach(ast.comments).join(' '));
            }
            if (_tokenizerEventHandlers.voidMap[ast.tag]) {
                if (ast.selfClosing) {
                    output.push(' /');
                }
                output.push('>');
            } else {
                output.push('>');
                output.push.apply(output, buildEach(ast.children));
                output.push('</', ast.tag, '>');
            }
            break;
        case 'AttrNode':
            output.push(ast.name, '=');
            const value = build(ast.value);
            if (ast.value.type === 'TextNode') {
                output.push('"', value, '"');
            } else {
                output.push(value);
            }
            break;
        case 'ConcatStatement':
            output.push('"');
            ast.parts.forEach(node => {
                if (node.type === 'StringLiteral') {
                    output.push(node.original);
                } else {
                    output.push(build(node));
                }
            });
            output.push('"');
            break;
        case 'TextNode':
            output.push(ast.chars);
            break;
        case 'MustacheStatement':
            {
                output.push(compactJoin(['{{', pathParams(ast), '}}']));
            }
            break;
        case 'MustacheCommentStatement':
            {
                output.push(compactJoin(['{{!--', ast.value, '--}}']));
            }
            break;
        case 'ElementModifierStatement':
            {
                output.push(compactJoin(['{{', pathParams(ast), '}}']));
            }
            break;
        case 'PathExpression':
            output.push(ast.original);
            break;
        case 'SubExpression':
            {
                output.push('(', pathParams(ast), ')');
            }
            break;
        case 'BooleanLiteral':
            output.push(ast.value ? 'true' : 'false');
            break;
        case 'BlockStatement':
            {
                const lines = [];
                if (ast['chained']) {
                    lines.push(['{{else ', pathParams(ast), '}}'].join(''));
                } else {
                    lines.push(openBlock(ast));
                }
                lines.push(build(ast.program));
                if (ast.inverse) {
                    if (!ast.inverse['chained']) {
                        lines.push('{{else}}');
                    }
                    lines.push(build(ast.inverse));
                }
                if (!ast['chained']) {
                    lines.push(closeBlock(ast));
                }
                output.push(lines.join(''));
            }
            break;
        case 'PartialStatement':
            {
                output.push(compactJoin(['{{>', pathParams(ast), '}}']));
            }
            break;
        case 'CommentStatement':
            {
                output.push(compactJoin(['<!--', ast.value, '-->']));
            }
            break;
        case 'StringLiteral':
            {
                output.push(`"${ast.value}"`);
            }
            break;
        case 'NumberLiteral':
            {
                output.push(String(ast.value));
            }
            break;
        case 'UndefinedLiteral':
            {
                output.push('undefined');
            }
            break;
        case 'NullLiteral':
            {
                output.push('null');
            }
            break;
        case 'Hash':
            {
                output.push(ast.pairs.map(pair => {
                    return build(pair);
                }).join(' '));
            }
            break;
        case 'HashPair':
            {
                output.push(`${ast.key}=${build(ast.value)}`);
            }
            break;
    }
    return output.join('');
}
function compact(array) {
    const newArray = [];
    array.forEach(a => {
        if (typeof a !== 'undefined' && a !== null && a !== '') {
            newArray.push(a);
        }
    });
    return newArray;
}
function buildEach(asts) {
    return asts.map(build);
}
function pathParams(ast) {
    let path;
    switch (ast.type) {
        case 'MustacheStatement':
        case 'SubExpression':
        case 'ElementModifierStatement':
        case 'BlockStatement':
            if (HBS.isLiteral(ast.path)) {
                return String(ast.path.value);
            }
            path = build(ast.path);
            break;
        case 'PartialStatement':
            path = build(ast.name);
            break;
        default:
            return unreachable();
    }
    return compactJoin([path, buildEach(ast.params).join(' '), build(ast.hash)], ' ');
}
function compactJoin(array, delimiter) {
    return compact(array).join(delimiter || '');
}
function blockParams(block) {
    const params = block.program.blockParams;
    if (params.length) {
        return ` as |${params.join(' ')}|`;
    }
    return null;
}
function openBlock(block) {
    return ['{{#', pathParams(block), blockParams(block), '}}'].join('');
}
function closeBlock(block) {
    return ['{{/', build(block.path), '}}'].join('');
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJpbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9AZ2xpbW1lci9zeW50YXgvbGliL2dlbmVyYXRpb24vcHJpbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUNBLEFBQU87O0lBQUssQUFBRyxBQUFNLEFBQWdCLEFBQUM7O0FBQ3RDLEFBQU8sQUFBRSxBQUFPLEFBQUUsQUFBTSxBQUFvQyxBQUFDOzs7O0FBRTdELHVCQUNFO1VBQU0sSUFBSSxBQUFLLE1BQUMsQUFBYSxBQUFDLEFBQUMsQUFDakMsQUFBQztBQUVELEFBQU0sQUFBQyxBQUFPO2VBQWdCLEFBQWEsS0FDekM7UUFBSSxDQUFDLEFBQUcsS0FBRSxBQUNSO2VBQU8sQUFBRSxBQUFDLEFBQ1g7QUFDRDtVQUFNLEFBQU0sU0FBYSxBQUFFLEFBQUMsQUFFNUI7WUFBUSxBQUFHLElBQUMsQUFBSSxBQUFFLEFBQ2hCO2FBQUssQUFBUyxBQUNaO0FBQ0U7c0JBQU0sQUFBVSxhQUFHLEFBQUcsSUFBQyxBQUFTLEFBQUMsY0FBSSxBQUFHLElBQUMsQUFBSSxLQUFDLEFBQUMsQUFBQyxBQUFDLEFBQ2pEO29CQUFJLEFBQVUsWUFBRSxBQUNkLEFBQVU7K0JBQUMsQUFBUyxBQUFDLGFBQUcsQUFBSSxBQUFDLEFBQzlCO0FBQ0Q7c0JBQU0sQUFBSSxPQUFHLEFBQVMsVUFBQyxBQUFHLElBQUMsQUFBSSxBQUFDLE1BQUMsQUFBSSxLQUFDLEFBQUUsQUFBQyxBQUFDLEFBQzFDLEFBQU07dUJBQUMsQUFBSSxLQUFDLEFBQUksQUFBQyxBQUFDLEFBQ25CO0FBQ0QsQUFBTTtBQUNSO2FBQUssQUFBYSxBQUNoQixBQUFNO21CQUFDLEFBQUksS0FBQyxBQUFHLEtBQUUsQUFBRyxJQUFDLEFBQUcsQUFBQyxBQUFDLEFBQzFCO2dCQUFJLEFBQUcsSUFBQyxBQUFVLFdBQUMsQUFBTSxRQUFFLEFBQ3pCLEFBQU07dUJBQUMsQUFBSSxLQUFDLEFBQUcs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QUVELG9CQUFvQixBQUFVLE9BQzVCO1dBQU8sQ0FBQyxBQUFLLE9BQUUsQUFBSyxNQUFDLEFBQUssTUFBQyxBQUFJLEFBQUMsT0FBRSxBQUFJLEFBQUMsTUFBQyxBQUFJLEtBQUMsQUFBRSxBQUFDLEFBQUMsQUFDbkQsQUFBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE9wdGlvbiB9IGZyb20gJ0BnbGltbWVyL2ludGVyZmFjZXMnO1xuaW1wb3J0ICogYXMgSEJTIGZyb20gJy4uL3R5cGVzL25vZGVzJztcbmltcG9ydCB7IHZvaWRNYXAgfSBmcm9tICcuLi9wYXJzZXIvdG9rZW5pemVyLWV2ZW50LWhhbmRsZXJzJztcblxuZnVuY3Rpb24gdW5yZWFjaGFibGUoKTogbmV2ZXIge1xuICB0aHJvdyBuZXcgRXJyb3IoJ3VucmVhY2hhYmxlJyk7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIGJ1aWxkKGFzdDogSEJTLk5vZGUpOiBzdHJpbmcge1xuICBpZiAoIWFzdCkge1xuICAgIHJldHVybiAnJztcbiAgfVxuICBjb25zdCBvdXRwdXQ6IHN0cmluZ1tdID0gW107XG5cbiAgc3dpdGNoIChhc3QudHlwZSkge1xuICAgIGNhc2UgJ1Byb2dyYW0nOlxuICAgICAge1xuICAgICAgICBjb25zdCBjaGFpbkJsb2NrID0gYXN0WydjaGFpbmVkJ10gJiYgYXN0LmJvZHlbMF07XG4gICAgICAgIGlmIChjaGFpbkJsb2NrKSB7XG4gICAgICAgICAgY2hhaW5CbG9ja1snY2hhaW5lZCddID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBib2R5ID0gYnVpbGRFYWNoKGFzdC5ib2R5KS5qb2luKCcnKTtcbiAgICAgICAgb3V0cHV0LnB1c2goYm9keSk7XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgICBjYXNlICdFbGVtZW50Tm9kZSc6XG4gICAgICBvdXRwdXQucHVzaCgnPCcsIGFzdC50YWcpO1xuICAgICAgaWYgKGFzdC5hdHRyaWJ1dGVzLmxlbmd0aCkge1xuICAgICAgICBvdXRwdXQucHVzaCgnICcsIGJ1aWxkRWFjaChhc3QuYXR0cmlidXRlcykuam9pbignICcpKTtcbiAgICAgIH1cbiAgICAgIGlmIChhc3QubW9kaWZpZXJzLmxlbmd0aCkge1xuICAgICAgICBvdXRwdXQucHVzaCgnICcsIGJ1aWxkRWFjaChhc3QubW9kaWZpZXJzKS5qb2luKCcgJykpO1xuICAgICAgfVxuICAgICAgaWYgKGFzdC5jb21tZW50cy5sZW5ndGgpIHtcbiAgICAgICAgb3V0cHV0LnB1c2goJyAnLCBidWlsZEVhY2goYXN0LmNvbW1lbnRzKS5qb2luKCcgJykpO1xuICAgICAgfVxuXG4gICAgICBpZiAodm9pZE1hcFthc3QudGFnXSkge1xuICAgICAgICBpZiAoYXN0LnNlbGZDbG9zaW5nKSB7XG4gICAgICAgICAgb3V0cHV0LnB1c2goJyAvJyk7XG4gICAgICAgIH1cblxuICAgICAgICBvdXRwdXQucHVzaCgnPicpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgb3V0cHV0LnB1c2goJz4nKTtcbiAgICAgICAgb3V0cHV0LnB1c2guYXBwbHkob3V0cHV0LCBidWlsZEVhY2goYXN0LmNoaWxkcmVuKSk7XG4gICAgICAgIG91dHB1dC5wdXNoKCc8LycsIGFzdC50YWcsICc+Jyk7XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgICBjYXNlICdBdHRyTm9kZSc6XG4gICAgICBvdXRwdXQucHVzaChhc3QubmFtZSwgJz0nKTtcbiAgICAgIGNvbnN0IHZhbHVlID0gYnVpbGQoYXN0LnZhbHVlKTtcbiAgICAgIGlmIChhc3QudmFsdWUudHlwZSA9PT0gJ1RleHROb2RlJykge1xuICAgICAgICBvdXRwdXQucHVzaCgnXCInLCB2YWx1ZSwgJ1wiJyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBvdXRwdXQucHVzaCh2YWx1ZSk7XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgICBjYXNlICdDb25jYXRTdGF0ZW1lbnQnOlxuICAgICAgb3V0cHV0LnB1c2goJ1wiJyk7XG4gICAgICBhc3QucGFydHMuZm9yRWFjaCgobm9kZTogYW55KSA9PiB7XG4gICAgICAgIGlmIChub2RlLnR5cGUgPT09ICdTdHJpbmdMaXRlcmFsJykge1xuICAgICAgICAgIG91dHB1dC5wdXNoKG5vZGUub3JpZ2luYWwpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIG91dHB1dC5wdXNoKGJ1aWxkKG5vZGUpKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICBvdXRwdXQucHVzaCgnXCInKTtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ1RleHROb2RlJzpcbiAgICAgIG91dHB1dC5wdXNoKGFzdC5jaGFycyk7XG4gICAgICBicmVhaztcbiAgICBjYXNlICdNdXN0YWNoZVN0YXRlbWVudCc6XG4gICAgICB7XG4gICAgICAgIG91dHB1dC5wdXNoKGNvbXBhY3RKb2luKFsne3snLCBwYXRoUGFyYW1zKGFzdCksICd9fSddKSk7XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgICBjYXNlICdNdXN0YWNoZUNvbW1lbnRTdGF0ZW1lbnQnOlxuICAgICAge1xuICAgICAgICBvdXRwdXQucHVzaChjb21wYWN0Sm9pbihbJ3t7IS0tJywgYXN0LnZhbHVlLCAnLS19fSddKSk7XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgICBjYXNlICdFbGVtZW50TW9kaWZpZXJTdGF0ZW1lbnQnOlxuICAgICAge1xuICAgICAgICBvdXRwdXQucHVzaChjb21wYWN0Sm9pbihbJ3t7JywgcGF0aFBhcmFtcyhhc3QpLCAnfX0nXSkpO1xuICAgICAgfVxuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnUGF0aEV4cHJlc3Npb24nOlxuICAgICAgb3V0cHV0LnB1c2goYXN0Lm9yaWdpbmFsKTtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ1N1YkV4cHJlc3Npb24nOlxuICAgICAge1xuICAgICAgICBvdXRwdXQucHVzaCgnKCcsIHBhdGhQYXJhbXMoYXN0KSwgJyknKTtcbiAgICAgIH1cbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ0Jvb2xlYW5MaXRlcmFsJzpcbiAgICAgIG91dHB1dC5wdXNoKGFzdC52YWx1ZSA/ICd0cnVlJyA6ICdmYWxzZScpO1xuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnQmxvY2tTdGF0ZW1lbnQnOlxuICAgICAge1xuICAgICAgICBjb25zdCBsaW5lczogc3RyaW5nW10gPSBbXTtcblxuICAgICAgICBpZiAoYXN0WydjaGFpbmVkJ10pIHtcbiAgICAgICAgICBsaW5lcy5wdXNoKFsne3tlbHNlICcsIHBhdGhQYXJhbXMoYXN0KSwgJ319J10uam9pbignJykpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGxpbmVzLnB1c2gob3BlbkJsb2NrKGFzdCkpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGluZXMucHVzaChidWlsZChhc3QucHJvZ3JhbSkpO1xuXG4gICAgICAgIGlmIChhc3QuaW52ZXJzZSkge1xuICAgICAgICAgIGlmICghYXN0LmludmVyc2VbJ2NoYWluZWQnXSkge1xuICAgICAgICAgICAgbGluZXMucHVzaCgne3tlbHNlfX0nKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgbGluZXMucHVzaChidWlsZChhc3QuaW52ZXJzZSkpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFhc3RbJ2NoYWluZWQnXSkge1xuICAgICAgICAgIGxpbmVzLnB1c2goY2xvc2VCbG9jayhhc3QpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIG91dHB1dC5wdXNoKGxpbmVzLmpvaW4oJycpKTtcbiAgICAgIH1cbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ1BhcnRpYWxTdGF0ZW1lbnQnOlxuICAgICAge1xuICAgICAgICBvdXRwdXQucHVzaChjb21wYWN0Sm9pbihbJ3t7PicsIHBhdGhQYXJhbXMoYXN0KSwgJ319J10pKTtcbiAgICAgIH1cbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ0NvbW1lbnRTdGF0ZW1lbnQnOlxuICAgICAge1xuICAgICAgICBvdXRwdXQucHVzaChjb21wYWN0Sm9pbihbJzwhLS0nLCBhc3QudmFsdWUsICctLT4nXSkpO1xuICAgICAgfVxuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnU3RyaW5nTGl0ZXJhbCc6XG4gICAgICB7XG4gICAgICAgIG91dHB1dC5wdXNoKGBcIiR7YXN0LnZhbHVlfVwiYCk7XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgICBjYXNlICdOdW1iZXJMaXRlcmFsJzpcbiAgICAgIHtcbiAgICAgICAgb3V0cHV0LnB1c2goU3RyaW5nKGFzdC52YWx1ZSkpO1xuICAgICAgfVxuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnVW5kZWZpbmVkTGl0ZXJhbCc6XG4gICAgICB7XG4gICAgICAgIG91dHB1dC5wdXNoKCd1bmRlZmluZWQnKTtcbiAgICAgIH1cbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ051bGxMaXRlcmFsJzpcbiAgICAgIHtcbiAgICAgICAgb3V0cHV0LnB1c2goJ251bGwnKTtcbiAgICAgIH1cbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ0hhc2gnOlxuICAgICAge1xuICAgICAgICBvdXRwdXQucHVzaChcbiAgICAgICAgICBhc3QucGFpcnNcbiAgICAgICAgICAgIC5tYXAocGFpciA9PiB7XG4gICAgICAgICAgICAgIHJldHVybiBidWlsZChwYWlyKTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAuam9pbignICcpXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgICBjYXNlICdIYXNoUGFpcic6XG4gICAgICB7XG4gICAgICAgIG91dHB1dC5wdXNoKGAke2FzdC5rZXl9PSR7YnVpbGQoYXN0LnZhbHVlKX1gKTtcbiAgICAgIH1cbiAgICAgIGJyZWFrO1xuICB9XG4gIHJldHVybiBvdXRwdXQuam9pbignJyk7XG59XG5cbmZ1bmN0aW9uIGNvbXBhY3QoYXJyYXk6IE9wdGlvbjxzdHJpbmc+W10pOiBzdHJpbmdbXSB7XG4gIGNvbnN0IG5ld0FycmF5OiBhbnlbXSA9IFtdO1xuICBhcnJheS5mb3JFYWNoKGEgPT4ge1xuICAgIGlmICh0eXBlb2YgYSAhPT0gJ3VuZGVmaW5lZCcgJiYgYSAhPT0gbnVsbCAmJiBhICE9PSAnJykge1xuICAgICAgbmV3QXJyYXkucHVzaChhKTtcbiAgICB9XG4gIH0pO1xuICByZXR1cm4gbmV3QXJyYXk7XG59XG5cbmZ1bmN0aW9uIGJ1aWxkRWFjaChhc3RzOiBIQlMuTm9kZVtdKTogc3RyaW5nW10ge1xuICByZXR1cm4gYXN0cy5tYXAoYnVpbGQpO1xufVxuXG5mdW5jdGlvbiBwYXRoUGFyYW1zKGFzdDogSEJTLk5vZGUpOiBzdHJpbmcge1xuICBsZXQgcGF0aDogc3RyaW5nO1xuXG4gIHN3aXRjaCAoYXN0LnR5cGUpIHtcbiAgICBjYXNlICdNdXN0YWNoZVN0YXRlbWVudCc6XG4gICAgY2FzZSAnU3ViRXhwcmVzc2lvbic6XG4gICAgY2FzZSAnRWxlbWVudE1vZGlmaWVyU3RhdGVtZW50JzpcbiAgICBjYXNlICdCbG9ja1N0YXRlbWVudCc6XG4gICAgICBpZiAoSEJTLmlzTGl0ZXJhbChhc3QucGF0aCkpIHtcbiAgICAgICAgcmV0dXJuIFN0cmluZyhhc3QucGF0aC52YWx1ZSk7XG4gICAgICB9XG5cbiAgICAgIHBhdGggPSBidWlsZChhc3QucGF0aCk7XG4gICAgICBicmVhaztcbiAgICBjYXNlICdQYXJ0aWFsU3RhdGVtZW50JzpcbiAgICAgIHBhdGggPSBidWlsZChhc3QubmFtZSk7XG4gICAgICBicmVhaztcbiAgICBkZWZhdWx0OlxuICAgICAgcmV0dXJuIHVucmVhY2hhYmxlKCk7XG4gIH1cblxuICByZXR1cm4gY29tcGFjdEpvaW4oW3BhdGgsIGJ1aWxkRWFjaChhc3QucGFyYW1zKS5qb2luKCcgJyksIGJ1aWxkKGFzdC5oYXNoKV0sICcgJyk7XG59XG5cbmZ1bmN0aW9uIGNvbXBhY3RKb2luKGFycmF5OiBPcHRpb248c3RyaW5nPltdLCBkZWxpbWl0ZXI/OiBzdHJpbmcpOiBzdHJpbmcge1xuICByZXR1cm4gY29tcGFjdChhcnJheSkuam9pbihkZWxpbWl0ZXIgfHwgJycpO1xufVxuXG5mdW5jdGlvbiBibG9ja1BhcmFtcyhibG9jazogSEJTLkJsb2NrU3RhdGVtZW50KTogT3B0aW9uPHN0cmluZz4ge1xuICBjb25zdCBwYXJhbXMgPSBibG9jay5wcm9ncmFtLmJsb2NrUGFyYW1zO1xuICBpZiAocGFyYW1zLmxlbmd0aCkge1xuICAgIHJldHVybiBgIGFzIHwke3BhcmFtcy5qb2luKCcgJyl9fGA7XG4gIH1cblxuICByZXR1cm4gbnVsbDtcbn1cblxuZnVuY3Rpb24gb3BlbkJsb2NrKGJsb2NrOiBIQlMuQmxvY2tTdGF0ZW1lbnQpOiBzdHJpbmcge1xuICByZXR1cm4gWyd7eyMnLCBwYXRoUGFyYW1zKGJsb2NrKSwgYmxvY2tQYXJhbXMoYmxvY2spLCAnfX0nXS5qb2luKCcnKTtcbn1cblxuZnVuY3Rpb24gY2xvc2VCbG9jayhibG9jazogYW55KTogc3RyaW5nIHtcbiAgcmV0dXJuIFsne3svJywgYnVpbGQoYmxvY2sucGF0aCksICd9fSddLmpvaW4oJycpO1xufVxuIl19