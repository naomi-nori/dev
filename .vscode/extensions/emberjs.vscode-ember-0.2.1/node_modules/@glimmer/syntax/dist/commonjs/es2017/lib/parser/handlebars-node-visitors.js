'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.HandlebarsNodeVisitors = undefined;

var _builders = require('../builders');

var _builders2 = _interopRequireDefault(_builders);

var _utils = require('../utils');

var _parser = require('../parser');

var _syntaxError = require('../errors/syntax-error');

var _syntaxError2 = _interopRequireDefault(_syntaxError);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class HandlebarsNodeVisitors extends _parser.Parser {
    constructor() {
        super(...arguments);
        this.cursorCount = 0;
    }
    cursor() {
        return `%cursor:${this.cursorCount++}%`;
    }
    Program(program) {
        let body = [];
        this.cursorCount = 0;
        let node = _builders2.default.program(body, program.blockParams, program.loc);
        let i,
            l = program.body.length;
        this.elementStack.push(node);
        if (l === 0) {
            return this.elementStack.pop();
        }
        for (i = 0; i < l; i++) {
            this.acceptNode(program.body[i]);
        }
        // Ensure that that the element stack is balanced properly.
        let poppedNode = this.elementStack.pop();
        if (poppedNode !== node) {
            let elementNode = poppedNode;
            throw new _syntaxError2.default('Unclosed element `' + elementNode.tag + '` (on line ' + elementNode.loc.start.line + ').', elementNode.loc);
        }
        return node;
    }
    BlockStatement(block) {
        if (this.tokenizer['state'] === 'comment') {
            this.appendToCommentData(this.sourceForNode(block));
            return;
        }
        if (this.tokenizer['state'] !== 'comment' && this.tokenizer['state'] !== 'data' && this.tokenizer['state'] !== 'beforeData') {
            throw new _syntaxError2.default('A block may only be used inside an HTML element or another block.', block.loc);
        }
        let { path, params, hash } = acceptCallNodes(this, block);
        let program = this.Program(block.program);
        let inverse = block.inverse ? this.Program(block.inverse) : null;
        if (path.original === 'in-element') {
            hash = addInElementHash(this.cursor(), hash, block.loc);
        }
        let node = _builders2.default.block(path, params, hash, program, inverse, block.loc);
        let parentProgram = this.currentElement();
        (0, _utils.appendChild)(parentProgram, node);
    }
    MustacheStatement(rawMustache) {
        let { tokenizer } = this;
        if (tokenizer['state'] === 'comment') {
            this.appendToCommentData(this.sourceForNode(rawMustache));
            return;
        }
        let mustache;
        let { escaped, loc } = rawMustache;
        if (rawMustache.path.type.match(/Literal$/)) {
            mustache = {
                type: 'MustacheStatement',
                path: this.acceptNode(rawMustache.path),
                params: [],
                hash: _builders2.default.hash(),
                escaped,
                loc
            };
        } else {
            let { path, params, hash } = acceptCallNodes(this, rawMustache);
            mustache = _builders2.default.mustache(path, params, hash, !escaped, loc);
        }
        switch (tokenizer.state) {
            // Tag helpers
            case "tagName" /* tagName */:
                addElementModifier(this.currentStartTag, mustache);
                tokenizer.transitionTo("beforeAttributeName" /* beforeAttributeName */);
                break;
            case "beforeAttributeName" /* beforeAttributeName */:
                addElementModifier(this.currentStartTag, mustache);
                break;
            case "attributeName" /* attributeName */:
            case "afterAttributeName" /* afterAttributeName */:
                this.beginAttributeValue(false);
                this.finishAttributeValue();
                addElementModifier(this.currentStartTag, mustache);
                tokenizer.transitionTo("beforeAttributeName" /* beforeAttributeName */);
                break;
            case "afterAttributeValueQuoted" /* afterAttributeValueQuoted */:
                addElementModifier(this.currentStartTag, mustache);
                tokenizer.transitionTo("beforeAttributeName" /* beforeAttributeName */);
                break;
            // Attribute values
            case "beforeAttributeValue" /* beforeAttributeValue */:
                this.beginAttributeValue(false);
                appendDynamicAttributeValuePart(this.currentAttribute, mustache);
                tokenizer.transitionTo("attributeValueUnquoted" /* attributeValueUnquoted */);
                break;
            case "attributeValueDoubleQuoted" /* attributeValueDoubleQuoted */:
            case "attributeValueSingleQuoted" /* attributeValueSingleQuoted */:
            case "attributeValueUnquoted" /* attributeValueUnquoted */:
                appendDynamicAttributeValuePart(this.currentAttribute, mustache);
                break;
            // TODO: Only append child when the tokenizer state makes
            // sense to do so, otherwise throw an error.
            default:
                (0, _utils.appendChild)(this.currentElement(), mustache);
        }
        return mustache;
    }
    ContentStatement(content) {
        updateTokenizerLocation(this.tokenizer, content);
        this.tokenizer.tokenizePart(content.value);
        this.tokenizer.flushData();
    }
    CommentStatement(rawComment) {
        let { tokenizer } = this;
        if (tokenizer.state === "comment" /* comment */) {
                this.appendToCommentData(this.sourceForNode(rawComment));
                return null;
            }
        let { value, loc } = rawComment;
        let comment = _builders2.default.mustacheComment(value, loc);
        switch (tokenizer.state) {
            case "beforeAttributeName" /* beforeAttributeName */:
                this.currentStartTag.comments.push(comment);
                break;
            case "beforeData" /* beforeData */:
            case "data" /* data */:
                (0, _utils.appendChild)(this.currentElement(), comment);
                break;
            default:
                throw new _syntaxError2.default(`Using a Handlebars comment when in the \`${tokenizer['state']}\` state is not supported: "${comment.value}" on line ${loc.start.line}:${loc.start.column}`, rawComment.loc);
        }
        return comment;
    }
    PartialStatement(partial) {
        let { loc } = partial;
        throw new _syntaxError2.default(`Handlebars partials are not supported: "${this.sourceForNode(partial, partial.name)}" at L${loc.start.line}:C${loc.start.column}`, partial.loc);
    }
    PartialBlockStatement(partialBlock) {
        let { loc } = partialBlock;
        throw new _syntaxError2.default(`Handlebars partial blocks are not supported: "${this.sourceForNode(partialBlock, partialBlock.name)}" at L${loc.start.line}:C${loc.start.column}`, partialBlock.loc);
    }
    Decorator(decorator) {
        let { loc } = decorator;
        throw new _syntaxError2.default(`Handlebars decorators are not supported: "${this.sourceForNode(decorator, decorator.path)}" at L${loc.start.line}:C${loc.start.column}`, decorator.loc);
    }
    DecoratorBlock(decoratorBlock) {
        let { loc } = decoratorBlock;
        throw new _syntaxError2.default(`Handlebars decorator blocks are not supported: "${this.sourceForNode(decoratorBlock, decoratorBlock.path)}" at L${loc.start.line}:C${loc.start.column}`, decoratorBlock.loc);
    }
    SubExpression(sexpr) {
        let { path, params, hash } = acceptCallNodes(this, sexpr);
        return _builders2.default.sexpr(path, params, hash, sexpr.loc);
    }
    PathExpression(path) {
        let { original, loc } = path;
        let parts;
        if (original.indexOf('/') !== -1) {
            if (original.slice(0, 2) === './') {
                throw new _syntaxError2.default(`Using "./" is not supported in Glimmer and unnecessary: "${path.original}" on line ${loc.start.line}.`, path.loc);
            }
            if (original.slice(0, 3) === '../') {
                throw new _syntaxError2.default(`Changing context using "../" is not supported in Glimmer: "${path.original}" on line ${loc.start.line}.`, path.loc);
            }
            if (original.indexOf('.') !== -1) {
                throw new _syntaxError2.default(`Mixing '.' and '/' in paths is not supported in Glimmer; use only '.' to separate property paths: "${path.original}" on line ${loc.start.line}.`, path.loc);
            }
            parts = [path.parts.join('/')];
        } else {
            parts = path.parts;
        }
        let thisHead = false;
        // This is to fix a bug in the Handlebars AST where the path expressions in
        // `{{this.foo}}` (and similarly `{{foo-bar this.foo named=this.foo}}` etc)
        // are simply turned into `{{foo}}`. The fix is to push it back onto the
        // parts array and let the runtime see the difference. However, we cannot
        // simply use the string `this` as it means literally the property called
        // "this" in the current context (it can be expressed in the syntax as
        // `{{[this]}}`, where the square bracket are generally for this kind of
        // escaping â€“ such as `{{foo.["bar.baz"]}}` would mean lookup a property
        // named literally "bar.baz" on `this.foo`). By convention, we use `null`
        // for this purpose.
        if (original.match(/^this(\..+)?$/)) {
            thisHead = true;
        }
        return {
            type: 'PathExpression',
            original: path.original,
            this: thisHead,
            parts,
            data: path.data,
            loc: path.loc
        };
    }
    Hash(hash) {
        let pairs = [];
        for (let i = 0; i < hash.pairs.length; i++) {
            let pair = hash.pairs[i];
            pairs.push(_builders2.default.pair(pair.key, this.acceptNode(pair.value), pair.loc));
        }
        return _builders2.default.hash(pairs, hash.loc);
    }
    StringLiteral(string) {
        return _builders2.default.literal('StringLiteral', string.value, string.loc);
    }
    BooleanLiteral(boolean) {
        return _builders2.default.literal('BooleanLiteral', boolean.value, boolean.loc);
    }
    NumberLiteral(number) {
        return _builders2.default.literal('NumberLiteral', number.value, number.loc);
    }
    UndefinedLiteral(undef) {
        return _builders2.default.literal('UndefinedLiteral', undefined, undef.loc);
    }
    NullLiteral(nul) {
        return _builders2.default.literal('NullLiteral', null, nul.loc);
    }
}
exports.HandlebarsNodeVisitors = HandlebarsNodeVisitors;
function calculateRightStrippedOffsets(original, value) {
    if (value === '') {
        // if it is empty, just return the count of newlines
        // in original
        return {
            lines: original.split('\n').length - 1,
            columns: 0
        };
    }
    // otherwise, return the number of newlines prior to
    // `value`
    let difference = original.split(value)[0];
    let lines = difference.split(/\n/);
    let lineCount = lines.length - 1;
    return {
        lines: lineCount,
        columns: lines[lineCount].length
    };
}
function updateTokenizerLocation(tokenizer, content) {
    let line = content.loc.start.line;
    let column = content.loc.start.column;
    let offsets = calculateRightStrippedOffsets(content.original, content.value);
    line = line + offsets.lines;
    if (offsets.lines) {
        column = offsets.columns;
    } else {
        column = column + offsets.columns;
    }
    tokenizer.line = line;
    tokenizer.column = column;
}
function acceptCallNodes(compiler, node) {
    let path = compiler.PathExpression(node.path);
    let params = node.params ? node.params.map(e => compiler.acceptNode(e)) : [];
    let hash = node.hash ? compiler.Hash(node.hash) : _builders2.default.hash();
    return { path, params, hash };
}
function addElementModifier(element, mustache) {
    let { path, params, hash, loc } = mustache;
    if ((0, _utils.isLiteral)(path)) {
        let modifier = `{{${(0, _utils.printLiteral)(path)}}}`;
        let tag = `<${element.name} ... ${modifier} ...`;
        throw new _syntaxError2.default(`In ${tag}, ${modifier} is not a valid modifier: "${path.original}" on line ${loc && loc.start.line}.`, mustache.loc);
    }
    let modifier = _builders2.default.elementModifier(path, params, hash, loc);
    element.modifiers.push(modifier);
}
function addInElementHash(cursor, hash, loc) {
    let hasNextSibling = false;
    hash.pairs.forEach(pair => {
        if (pair.key === 'guid') {
            throw new _syntaxError2.default('Cannot pass `guid` from user space', loc);
        }
        if (pair.key === 'nextSibling') {
            hasNextSibling = true;
        }
    });
    let guid = _builders2.default.literal('StringLiteral', cursor);
    let guidPair = _builders2.default.pair('guid', guid);
    hash.pairs.unshift(guidPair);
    if (!hasNextSibling) {
        let nullLiteral = _builders2.default.literal('NullLiteral', null);
        let nextSibling = _builders2.default.pair('nextSibling', nullLiteral);
        hash.pairs.push(nextSibling);
    }
    return hash;
}
function appendDynamicAttributeValuePart(attribute, part) {
    attribute.isDynamic = true;
    attribute.parts.push(part);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGFuZGxlYmFycy1ub2RlLXZpc2l0b3JzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcGFja2FnZXMvQGdsaW1tZXIvc3ludGF4L2xpYi9wYXJzZXIvaGFuZGxlYmFycy1ub2RlLXZpc2l0b3JzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQSxBQUFPLEFBQUMsQUFBTSxBQUFhLEFBQUM7Ozs7QUFDNUIsQUFBTyxBQUFFLEFBQVcsQUFBRSxBQUFTLEFBQUUsQUFBWSxBQUFFLEFBQU0sQUFBVSxBQUFDOztBQUdoRSxBQUFPLEFBQUUsQUFBTSxBQUFrQixBQUFNLEFBQVcsQUFBQzs7QUFDbkQsQUFBTyxBQUFXLEFBQU0sQUFBd0IsQUFBQyxBQUtqRCxBQUFNOzs7Ozs7TUFBdUMsQUFBUSxBQUFNOztpQkFLekQ7YUFBVyxjQUFHLEFBQUMsQUFBQyxBQXNVbEIsQUFBQztBQXBVQyxBQUFNO2FBQ0osQUFBTzswQkFBVyxBQUFJLEtBQUMsQUFBVyxBQUFFLEFBQUcsQUFBQyxBQUMxQyxhQUFDO0FBRUQsQUFBTztZQUFDLEFBQThCLFNBQ3BDO1lBQUksQUFBSSxPQUFvQixBQUFFLEFBQUMsQUFDL0IsQUFBSTthQUFDLEFBQVcsY0FBRyxBQUFDLEFBQUMsQUFDckI7WUFBSSxBQUFJLE9BQUcsQUFBQyxtQkFBQyxBQUFPLFFBQUMsQUFBSSxNQUFFLEFBQU8sUUFBQyxBQUFXLGFBQUUsQUFBTyxRQUFDLEFBQUcsQUFBQyxBQUFDLEFBQzdEO1lBQUksQUFBQztZQUNILEFBQUMsSUFBRyxBQUFPLFFBQUMsQUFBSSxLQUFDLEFBQU0sQUFBQyxBQUUxQixBQUFJO2FBQUMsQUFBWSxhQUFDLEFBQUksS0FBQyxBQUFJLEFBQUMsQUFBQyxBQUU3QjtZQUFJLEFBQUMsTUFBSyxBQUFDLEdBQUUsQUFDWDttQkFBTyxBQUFJLEtBQUMsQUFBWSxhQUFDLEFBQUcsQUFBaUIsQUFBQyxBQUMvQztBQUVEO2FBQUssQUFBQyxJQUFH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QUFNLFFBQUUsQUFBSSxBQUFDLEFBQUMsQUFDcEMsQUFBSTtTQUFDLEFBQUssTUFBQyxBQUFPLFFBQUMsQUFBUSxBQUFDLEFBQUMsQUFFN0I7UUFBSSxDQUFDLEFBQWMsZ0JBQUUsQUFDbkI7WUFBSSxBQUFXLGNBQUcsQUFBQyxtQkFBQyxBQUFPLFFBQUMsQUFBYSxlQUFFLEFBQUksQUFBQyxBQUFDLEFBQ2pEO1lBQUksQUFBVyxjQUFHLEFBQUMsbUJBQUMsQUFBSSxLQUFDLEFBQWEsZUFBRSxBQUFXLEFBQUMsQUFBQyxBQUNyRCxBQUFJO2FBQUMsQUFBSyxNQUFDLEFBQUksS0FBQyxBQUFXLEFBQUMsQUFBQyxBQUM5QjtBQUVEO1dBQU8sQUFBSSxBQUFDLEFBQ2QsQUFBQzs7QUFFRCx5Q0FBeUMsQUFBb0IsV0FBRSxBQUEyQixNQUN4RixBQUFTO2NBQUMsQUFBUyxZQUFHLEFBQUksQUFBQyxBQUMzQixBQUFTO2NBQUMsQUFBSyxNQUFDLEFBQUksS0FBQyxBQUFJLEFBQUMsQUFBQyxBQUM3QixBQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGIgZnJvbSAnLi4vYnVpbGRlcnMnO1xuaW1wb3J0IHsgYXBwZW5kQ2hpbGQsIGlzTGl0ZXJhbCwgcHJpbnRMaXRlcmFsIH0gZnJvbSAnLi4vdXRpbHMnO1xuaW1wb3J0ICogYXMgQVNUIGZyb20gJy4uL3R5cGVzL25vZGVzJztcbmltcG9ydCAqIGFzIEhhbmRsZWJhcnNBU1QgZnJvbSAnLi4vdHlwZXMvaGFuZGxlYmFycy1hc3QnO1xuaW1wb3J0IHsgUGFyc2VyLCBUYWcsIEF0dHJpYnV0ZSB9IGZyb20gJy4uL3BhcnNlcic7XG5pbXBvcnQgU3ludGF4RXJyb3IgZnJvbSAnLi4vZXJyb3JzL3N5bnRheC1lcnJvcic7XG5pbXBvcnQgeyBPcHRpb24gfSBmcm9tICdAZ2xpbW1lci91dGlsJztcbmltcG9ydCB7IFJlY2FzdCB9IGZyb20gJ0BnbGltbWVyL2ludGVyZmFjZXMnO1xuaW1wb3J0IHsgVG9rZW5pemVyU3RhdGUgfSBmcm9tICdzaW1wbGUtaHRtbC10b2tlbml6ZXInO1xuXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgSGFuZGxlYmFyc05vZGVWaXNpdG9ycyBleHRlbmRzIFBhcnNlciB7XG4gIGFic3RyYWN0IGFwcGVuZFRvQ29tbWVudERhdGEoczogc3RyaW5nKTogdm9pZDtcbiAgYWJzdHJhY3QgYmVnaW5BdHRyaWJ1dGVWYWx1ZShxdW90ZWQ6IGJvb2xlYW4pOiB2b2lkO1xuICBhYnN0cmFjdCBmaW5pc2hBdHRyaWJ1dGVWYWx1ZSgpOiB2b2lkO1xuXG4gIGN1cnNvckNvdW50ID0gMDtcblxuICBjdXJzb3IoKSB7XG4gICAgcmV0dXJuIGAlY3Vyc29yOiR7dGhpcy5jdXJzb3JDb3VudCsrfSVgO1xuICB9XG5cbiAgUHJvZ3JhbShwcm9ncmFtOiBIYW5kbGViYXJzQVNULlByb2dyYW0pOiBBU1QuUHJvZ3JhbSB7XG4gICAgbGV0IGJvZHk6IEFTVC5TdGF0ZW1lbnRbXSA9IFtdO1xuICAgIHRoaXMuY3Vyc29yQ291bnQgPSAwO1xuICAgIGxldCBub2RlID0gYi5wcm9ncmFtKGJvZHksIHByb2dyYW0uYmxvY2tQYXJhbXMsIHByb2dyYW0ubG9jKTtcbiAgICBsZXQgaSxcbiAgICAgIGwgPSBwcm9ncmFtLmJvZHkubGVuZ3RoO1xuXG4gICAgdGhpcy5lbGVtZW50U3RhY2sucHVzaChub2RlKTtcblxuICAgIGlmIChsID09PSAwKSB7XG4gICAgICByZXR1cm4gdGhpcy5lbGVtZW50U3RhY2sucG9wKCkgYXMgQVNULlByb2dyYW07XG4gICAgfVxuXG4gICAgZm9yIChpID0gMDsgaSA8IGw7IGkrKykge1xuICAgICAgdGhpcy5hY2NlcHROb2RlKHByb2dyYW0uYm9keVtpXSk7XG4gICAgfVxuXG4gICAgLy8gRW5zdXJlIHRoYXQgdGhhdCB0aGUgZWxlbWVudCBzdGFjayBpcyBiYWxhbmNlZCBwcm9wZXJseS5cbiAgICBsZXQgcG9wcGVkTm9kZSA9IHRoaXMuZWxlbWVudFN0YWNrLnBvcCgpO1xuICAgIGlmIChwb3BwZWROb2RlICE9PSBub2RlKSB7XG4gICAgICBsZXQgZWxlbWVudE5vZGUgPSBwb3BwZWROb2RlIGFzIEFTVC5FbGVtZW50Tm9kZTtcblxuICAgICAgdGhyb3cgbmV3IFN5bnRheEVycm9yKFxuICAgICAgICAnVW5jbG9zZWQgZWxlbWVudCBgJyArIGVsZW1lbnROb2RlLnRhZyArICdgIChvbiBsaW5lICcgKyBlbGVtZW50Tm9kZS5sb2MhLnN0YXJ0LmxpbmUgKyAnKS4nLFxuICAgICAgICBlbGVtZW50Tm9kZS5sb2NcbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIG5vZGU7XG4gIH1cblxuICBCbG9ja1N0YXRlbWVudChibG9jazogSGFuZGxlYmFyc0FTVC5CbG9ja1N0YXRlbWVudCkge1xuICAgIGlmICh0aGlzLnRva2VuaXplclsnc3RhdGUnXSA9PT0gJ2NvbW1lbnQnKSB7XG4gICAgICB0aGlzLmFwcGVuZFRvQ29tbWVudERhdGEodGhpcy5zb3VyY2VGb3JOb2RlKGJsb2NrKSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKFxuICAgICAgdGhpcy50b2tlbml6ZXJbJ3N0YXRlJ10gIT09ICdjb21tZW50JyAmJlxuICAgICAgdGhpcy50b2tlbml6ZXJbJ3N0YXRlJ10gIT09ICdkYXRhJyAmJlxuICAgICAgdGhpcy50b2tlbml6ZXJbJ3N0YXRlJ10gIT09ICdiZWZvcmVEYXRhJ1xuICAgICkge1xuICAgICAgdGhyb3cgbmV3IFN5bnRheEVycm9yKFxuICAgICAgICAnQSBibG9jayBtYXkgb25seSBiZSB1c2VkIGluc2lkZSBhbiBIVE1MIGVsZW1lbnQgb3IgYW5vdGhlciBibG9jay4nLFxuICAgICAgICBibG9jay5sb2NcbiAgICAgICk7XG4gICAgfVxuXG4gICAgbGV0IHsgcGF0aCwgcGFyYW1zLCBoYXNoIH0gPSBhY2NlcHRDYWxsTm9kZXModGhpcywgYmxvY2spO1xuICAgIGxldCBwcm9ncmFtID0gdGhpcy5Qcm9ncmFtKGJsb2NrLnByb2dyYW0pO1xuICAgIGxldCBpbnZlcnNlID0gYmxvY2suaW52ZXJzZSA/IHRoaXMuUHJvZ3JhbShibG9jay5pbnZlcnNlKSA6IG51bGw7XG5cbiAgICBpZiAocGF0aC5vcmlnaW5hbCA9PT0gJ2luLWVsZW1lbnQnKSB7XG4gICAgICBoYXNoID0gYWRkSW5FbGVtZW50SGFzaCh0aGlzLmN1cnNvcigpLCBoYXNoLCBibG9jay5sb2MpO1xuICAgIH1cblxuICAgIGxldCBub2RlID0gYi5ibG9jayhwYXRoLCBwYXJhbXMsIGhhc2gsIHByb2dyYW0sIGludmVyc2UsIGJsb2NrLmxvYyk7XG5cbiAgICBsZXQgcGFyZW50UHJvZ3JhbSA9IHRoaXMuY3VycmVudEVsZW1lbnQoKTtcbiAgICBhcHBlbmRDaGlsZChwYXJlbnRQcm9ncmFtLCBub2RlKTtcbiAgfVxuXG4gIE11c3RhY2hlU3RhdGVtZW50KHJhd011c3RhY2hlOiBIYW5kbGViYXJzQVNULk11c3RhY2hlU3RhdGVtZW50KSB7XG4gICAgbGV0IHsgdG9rZW5pemVyIH0gPSB0aGlzO1xuXG4gICAgaWYgKHRva2VuaXplclsnc3RhdGUnXSA9PT0gJ2NvbW1lbnQnKSB7XG4gICAgICB0aGlzLmFwcGVuZFRvQ29tbWVudERhdGEodGhpcy5zb3VyY2VGb3JOb2RlKHJhd011c3RhY2hlKSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgbGV0IG11c3RhY2hlOiBBU1QuTXVzdGFjaGVTdGF0ZW1lbnQ7XG4gICAgbGV0IHsgZXNjYXBlZCwgbG9jIH0gPSByYXdNdXN0YWNoZTtcblxuICAgIGlmIChyYXdNdXN0YWNoZS5wYXRoLnR5cGUubWF0Y2goL0xpdGVyYWwkLykpIHtcbiAgICAgIG11c3RhY2hlID0ge1xuICAgICAgICB0eXBlOiAnTXVzdGFjaGVTdGF0ZW1lbnQnLFxuICAgICAgICBwYXRoOiB0aGlzLmFjY2VwdE5vZGU8QVNULkxpdGVyYWw+KHJhd011c3RhY2hlLnBhdGgpLFxuICAgICAgICBwYXJhbXM6IFtdLFxuICAgICAgICBoYXNoOiBiLmhhc2goKSxcbiAgICAgICAgZXNjYXBlZCxcbiAgICAgICAgbG9jLFxuICAgICAgfTtcbiAgICB9IGVsc2Uge1xuICAgICAgbGV0IHsgcGF0aCwgcGFyYW1zLCBoYXNoIH0gPSBhY2NlcHRDYWxsTm9kZXMoXG4gICAgICAgIHRoaXMsXG4gICAgICAgIHJhd011c3RhY2hlIGFzIEhhbmRsZWJhcnNBU1QuTXVzdGFjaGVTdGF0ZW1lbnQgJiB7XG4gICAgICAgICAgcGF0aDogSGFuZGxlYmFyc0FTVC5QYXRoRXhwcmVzc2lvbjtcbiAgICAgICAgfVxuICAgICAgKTtcbiAgICAgIG11c3RhY2hlID0gYi5tdXN0YWNoZShwYXRoLCBwYXJhbXMsIGhhc2gsICFlc2NhcGVkLCBsb2MpO1xuICAgIH1cblxuICAgIHN3aXRjaCAodG9rZW5pemVyLnN0YXRlKSB7XG4gICAgICAvLyBUYWcgaGVscGVyc1xuICAgICAgY2FzZSBUb2tlbml6ZXJTdGF0ZS50YWdOYW1lOlxuICAgICAgICBhZGRFbGVtZW50TW9kaWZpZXIodGhpcy5jdXJyZW50U3RhcnRUYWcsIG11c3RhY2hlKTtcbiAgICAgICAgdG9rZW5pemVyLnRyYW5zaXRpb25UbyhUb2tlbml6ZXJTdGF0ZS5iZWZvcmVBdHRyaWJ1dGVOYW1lKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFRva2VuaXplclN0YXRlLmJlZm9yZUF0dHJpYnV0ZU5hbWU6XG4gICAgICAgIGFkZEVsZW1lbnRNb2RpZmllcih0aGlzLmN1cnJlbnRTdGFydFRhZywgbXVzdGFjaGUpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgVG9rZW5pemVyU3RhdGUuYXR0cmlidXRlTmFtZTpcbiAgICAgIGNhc2UgVG9rZW5pemVyU3RhdGUuYWZ0ZXJBdHRyaWJ1dGVOYW1lOlxuICAgICAgICB0aGlzLmJlZ2luQXR0cmlidXRlVmFsdWUoZmFsc2UpO1xuICAgICAgICB0aGlzLmZpbmlzaEF0dHJpYnV0ZVZhbHVlKCk7XG4gICAgICAgIGFkZEVsZW1lbnRNb2RpZmllcih0aGlzLmN1cnJlbnRTdGFydFRhZywgbXVzdGFjaGUpO1xuICAgICAgICB0b2tlbml6ZXIudHJhbnNpdGlvblRvKFRva2VuaXplclN0YXRlLmJlZm9yZUF0dHJpYnV0ZU5hbWUpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgVG9rZW5pemVyU3RhdGUuYWZ0ZXJBdHRyaWJ1dGVWYWx1ZVF1b3RlZDpcbiAgICAgICAgYWRkRWxlbWVudE1vZGlmaWVyKHRoaXMuY3VycmVudFN0YXJ0VGFnLCBtdXN0YWNoZSk7XG4gICAgICAgIHRva2VuaXplci50cmFuc2l0aW9uVG8oVG9rZW5pemVyU3RhdGUuYmVmb3JlQXR0cmlidXRlTmFtZSk7XG4gICAgICAgIGJyZWFrO1xuXG4gICAgICAvLyBBdHRyaWJ1dGUgdmFsdWVzXG4gICAgICBjYXNlIFRva2VuaXplclN0YXRlLmJlZm9yZUF0dHJpYnV0ZVZhbHVlOlxuICAgICAgICB0aGlzLmJlZ2luQXR0cmlidXRlVmFsdWUoZmFsc2UpO1xuICAgICAgICBhcHBlbmREeW5hbWljQXR0cmlidXRlVmFsdWVQYXJ0KHRoaXMuY3VycmVudEF0dHJpYnV0ZSEsIG11c3RhY2hlKTtcbiAgICAgICAgdG9rZW5pemVyLnRyYW5zaXRpb25UbyhUb2tlbml6ZXJTdGF0ZS5hdHRyaWJ1dGVWYWx1ZVVucXVvdGVkKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFRva2VuaXplclN0YXRlLmF0dHJpYnV0ZVZhbHVlRG91YmxlUXVvdGVkOlxuICAgICAgY2FzZSBUb2tlbml6ZXJTdGF0ZS5hdHRyaWJ1dGVWYWx1ZVNpbmdsZVF1b3RlZDpcbiAgICAgIGNhc2UgVG9rZW5pemVyU3RhdGUuYXR0cmlidXRlVmFsdWVVbnF1b3RlZDpcbiAgICAgICAgYXBwZW5kRHluYW1pY0F0dHJpYnV0ZVZhbHVlUGFydCh0aGlzLmN1cnJlbnRBdHRyaWJ1dGUhLCBtdXN0YWNoZSk7XG4gICAgICAgIGJyZWFrO1xuXG4gICAgICAvLyBUT0RPOiBPbmx5IGFwcGVuZCBjaGlsZCB3aGVuIHRoZSB0b2tlbml6ZXIgc3RhdGUgbWFrZXNcbiAgICAgIC8vIHNlbnNlIHRvIGRvIHNvLCBvdGhlcndpc2UgdGhyb3cgYW4gZXJyb3IuXG4gICAgICBkZWZhdWx0OlxuICAgICAgICBhcHBlbmRDaGlsZCh0aGlzLmN1cnJlbnRFbGVtZW50KCksIG11c3RhY2hlKTtcbiAgICB9XG5cbiAgICByZXR1cm4gbXVzdGFjaGU7XG4gIH1cblxuICBDb250ZW50U3RhdGVtZW50KGNvbnRlbnQ6IEhhbmRsZWJhcnNBU1QuQ29udGVudFN0YXRlbWVudCkge1xuICAgIHVwZGF0ZVRva2VuaXplckxvY2F0aW9uKHRoaXMudG9rZW5pemVyLCBjb250ZW50KTtcblxuICAgIHRoaXMudG9rZW5pemVyLnRva2VuaXplUGFydChjb250ZW50LnZhbHVlKTtcbiAgICB0aGlzLnRva2VuaXplci5mbHVzaERhdGEoKTtcbiAgfVxuXG4gIENvbW1lbnRTdGF0ZW1lbnQoXG4gICAgcmF3Q29tbWVudDogSGFuZGxlYmFyc0FTVC5Db21tZW50U3RhdGVtZW50XG4gICk6IE9wdGlvbjxBU1QuTXVzdGFjaGVDb21tZW50U3RhdGVtZW50PiB7XG4gICAgbGV0IHsgdG9rZW5pemVyIH0gPSB0aGlzO1xuXG4gICAgaWYgKHRva2VuaXplci5zdGF0ZSA9PT0gVG9rZW5pemVyU3RhdGUuY29tbWVudCkge1xuICAgICAgdGhpcy5hcHBlbmRUb0NvbW1lbnREYXRhKHRoaXMuc291cmNlRm9yTm9kZShyYXdDb21tZW50KSk7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBsZXQgeyB2YWx1ZSwgbG9jIH0gPSByYXdDb21tZW50O1xuICAgIGxldCBjb21tZW50ID0gYi5tdXN0YWNoZUNvbW1lbnQodmFsdWUsIGxvYyk7XG5cbiAgICBzd2l0Y2ggKHRva2VuaXplci5zdGF0ZSkge1xuICAgICAgY2FzZSBUb2tlbml6ZXJTdGF0ZS5iZWZvcmVBdHRyaWJ1dGVOYW1lOlxuICAgICAgICB0aGlzLmN1cnJlbnRTdGFydFRhZy5jb21tZW50cy5wdXNoKGNvbW1lbnQpO1xuICAgICAgICBicmVhaztcblxuICAgICAgY2FzZSBUb2tlbml6ZXJTdGF0ZS5iZWZvcmVEYXRhOlxuICAgICAgY2FzZSBUb2tlbml6ZXJTdGF0ZS5kYXRhOlxuICAgICAgICBhcHBlbmRDaGlsZCh0aGlzLmN1cnJlbnRFbGVtZW50KCksIGNvbW1lbnQpO1xuICAgICAgICBicmVhaztcblxuICAgICAgZGVmYXVsdDpcbiAgICAgICAgdGhyb3cgbmV3IFN5bnRheEVycm9yKFxuICAgICAgICAgIGBVc2luZyBhIEhhbmRsZWJhcnMgY29tbWVudCB3aGVuIGluIHRoZSBcXGAke1xuICAgICAgICAgICAgdG9rZW5pemVyWydzdGF0ZSddXG4gICAgICAgICAgfVxcYCBzdGF0ZSBpcyBub3Qgc3VwcG9ydGVkOiBcIiR7Y29tbWVudC52YWx1ZX1cIiBvbiBsaW5lICR7bG9jLnN0YXJ0LmxpbmV9OiR7XG4gICAgICAgICAgICBsb2Muc3RhcnQuY29sdW1uXG4gICAgICAgICAgfWAsXG4gICAgICAgICAgcmF3Q29tbWVudC5sb2NcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gY29tbWVudDtcbiAgfVxuXG4gIFBhcnRpYWxTdGF0ZW1lbnQocGFydGlhbDogSGFuZGxlYmFyc0FTVC5QYXJ0aWFsU3RhdGVtZW50KSB7XG4gICAgbGV0IHsgbG9jIH0gPSBwYXJ0aWFsO1xuXG4gICAgdGhyb3cgbmV3IFN5bnRheEVycm9yKFxuICAgICAgYEhhbmRsZWJhcnMgcGFydGlhbHMgYXJlIG5vdCBzdXBwb3J0ZWQ6IFwiJHt0aGlzLnNvdXJjZUZvck5vZGUocGFydGlhbCwgcGFydGlhbC5uYW1lKX1cIiBhdCBMJHtcbiAgICAgICAgbG9jLnN0YXJ0LmxpbmVcbiAgICAgIH06QyR7bG9jLnN0YXJ0LmNvbHVtbn1gLFxuICAgICAgcGFydGlhbC5sb2NcbiAgICApO1xuICB9XG5cbiAgUGFydGlhbEJsb2NrU3RhdGVtZW50KHBhcnRpYWxCbG9jazogSGFuZGxlYmFyc0FTVC5QYXJ0aWFsQmxvY2tTdGF0ZW1lbnQpIHtcbiAgICBsZXQgeyBsb2MgfSA9IHBhcnRpYWxCbG9jaztcblxuICAgIHRocm93IG5ldyBTeW50YXhFcnJvcihcbiAgICAgIGBIYW5kbGViYXJzIHBhcnRpYWwgYmxvY2tzIGFyZSBub3Qgc3VwcG9ydGVkOiBcIiR7dGhpcy5zb3VyY2VGb3JOb2RlKFxuICAgICAgICBwYXJ0aWFsQmxvY2ssXG4gICAgICAgIHBhcnRpYWxCbG9jay5uYW1lXG4gICAgICApfVwiIGF0IEwke2xvYy5zdGFydC5saW5lfTpDJHtsb2Muc3RhcnQuY29sdW1ufWAsXG4gICAgICBwYXJ0aWFsQmxvY2subG9jXG4gICAgKTtcbiAgfVxuXG4gIERlY29yYXRvcihkZWNvcmF0b3I6IEhhbmRsZWJhcnNBU1QuRGVjb3JhdG9yKSB7XG4gICAgbGV0IHsgbG9jIH0gPSBkZWNvcmF0b3I7XG5cbiAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoXG4gICAgICBgSGFuZGxlYmFycyBkZWNvcmF0b3JzIGFyZSBub3Qgc3VwcG9ydGVkOiBcIiR7dGhpcy5zb3VyY2VGb3JOb2RlKFxuICAgICAgICBkZWNvcmF0b3IsXG4gICAgICAgIGRlY29yYXRvci5wYXRoXG4gICAgICApfVwiIGF0IEwke2xvYy5zdGFydC5saW5lfTpDJHtsb2Muc3RhcnQuY29sdW1ufWAsXG4gICAgICBkZWNvcmF0b3IubG9jXG4gICAgKTtcbiAgfVxuXG4gIERlY29yYXRvckJsb2NrKGRlY29yYXRvckJsb2NrOiBIYW5kbGViYXJzQVNULkRlY29yYXRvckJsb2NrKSB7XG4gICAgbGV0IHsgbG9jIH0gPSBkZWNvcmF0b3JCbG9jaztcblxuICAgIHRocm93IG5ldyBTeW50YXhFcnJvcihcbiAgICAgIGBIYW5kbGViYXJzIGRlY29yYXRvciBibG9ja3MgYXJlIG5vdCBzdXBwb3J0ZWQ6IFwiJHt0aGlzLnNvdXJjZUZvck5vZGUoXG4gICAgICAgIGRlY29yYXRvckJsb2NrLFxuICAgICAgICBkZWNvcmF0b3JCbG9jay5wYXRoXG4gICAgICApfVwiIGF0IEwke2xvYy5zdGFydC5saW5lfTpDJHtsb2Muc3RhcnQuY29sdW1ufWAsXG4gICAgICBkZWNvcmF0b3JCbG9jay5sb2NcbiAgICApO1xuICB9XG5cbiAgU3ViRXhwcmVzc2lvbihzZXhwcjogSGFuZGxlYmFyc0FTVC5TdWJFeHByZXNzaW9uKTogQVNULlN1YkV4cHJlc3Npb24ge1xuICAgIGxldCB7IHBhdGgsIHBhcmFtcywgaGFzaCB9ID0gYWNjZXB0Q2FsbE5vZGVzKHRoaXMsIHNleHByKTtcbiAgICByZXR1cm4gYi5zZXhwcihwYXRoLCBwYXJhbXMsIGhhc2gsIHNleHByLmxvYyk7XG4gIH1cblxuICBQYXRoRXhwcmVzc2lvbihwYXRoOiBIYW5kbGViYXJzQVNULlBhdGhFeHByZXNzaW9uKTogQVNULlBhdGhFeHByZXNzaW9uIHtcbiAgICBsZXQgeyBvcmlnaW5hbCwgbG9jIH0gPSBwYXRoO1xuICAgIGxldCBwYXJ0czogc3RyaW5nW107XG5cbiAgICBpZiAob3JpZ2luYWwuaW5kZXhPZignLycpICE9PSAtMSkge1xuICAgICAgaWYgKG9yaWdpbmFsLnNsaWNlKDAsIDIpID09PSAnLi8nKSB7XG4gICAgICAgIHRocm93IG5ldyBTeW50YXhFcnJvcihcbiAgICAgICAgICBgVXNpbmcgXCIuL1wiIGlzIG5vdCBzdXBwb3J0ZWQgaW4gR2xpbW1lciBhbmQgdW5uZWNlc3Nhcnk6IFwiJHtwYXRoLm9yaWdpbmFsfVwiIG9uIGxpbmUgJHtcbiAgICAgICAgICAgIGxvYy5zdGFydC5saW5lXG4gICAgICAgICAgfS5gLFxuICAgICAgICAgIHBhdGgubG9jXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBpZiAob3JpZ2luYWwuc2xpY2UoMCwgMykgPT09ICcuLi8nKSB7XG4gICAgICAgIHRocm93IG5ldyBTeW50YXhFcnJvcihcbiAgICAgICAgICBgQ2hhbmdpbmcgY29udGV4dCB1c2luZyBcIi4uL1wiIGlzIG5vdCBzdXBwb3J0ZWQgaW4gR2xpbW1lcjogXCIke3BhdGgub3JpZ2luYWx9XCIgb24gbGluZSAke1xuICAgICAgICAgICAgbG9jLnN0YXJ0LmxpbmVcbiAgICAgICAgICB9LmAsXG4gICAgICAgICAgcGF0aC5sb2NcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIGlmIChvcmlnaW5hbC5pbmRleE9mKCcuJykgIT09IC0xKSB7XG4gICAgICAgIHRocm93IG5ldyBTeW50YXhFcnJvcihcbiAgICAgICAgICBgTWl4aW5nICcuJyBhbmQgJy8nIGluIHBhdGhzIGlzIG5vdCBzdXBwb3J0ZWQgaW4gR2xpbW1lcjsgdXNlIG9ubHkgJy4nIHRvIHNlcGFyYXRlIHByb3BlcnR5IHBhdGhzOiBcIiR7XG4gICAgICAgICAgICBwYXRoLm9yaWdpbmFsXG4gICAgICAgICAgfVwiIG9uIGxpbmUgJHtsb2Muc3RhcnQubGluZX0uYCxcbiAgICAgICAgICBwYXRoLmxvY1xuICAgICAgICApO1xuICAgICAgfVxuICAgICAgcGFydHMgPSBbcGF0aC5wYXJ0cy5qb2luKCcvJyldO1xuICAgIH0gZWxzZSB7XG4gICAgICBwYXJ0cyA9IHBhdGgucGFydHM7XG4gICAgfVxuXG4gICAgbGV0IHRoaXNIZWFkID0gZmFsc2U7XG5cbiAgICAvLyBUaGlzIGlzIHRvIGZpeCBhIGJ1ZyBpbiB0aGUgSGFuZGxlYmFycyBBU1Qgd2hlcmUgdGhlIHBhdGggZXhwcmVzc2lvbnMgaW5cbiAgICAvLyBge3t0aGlzLmZvb319YCAoYW5kIHNpbWlsYXJseSBge3tmb28tYmFyIHRoaXMuZm9vIG5hbWVkPXRoaXMuZm9vfX1gIGV0YylcbiAgICAvLyBhcmUgc2ltcGx5IHR1cm5lZCBpbnRvIGB7e2Zvb319YC4gVGhlIGZpeCBpcyB0byBwdXNoIGl0IGJhY2sgb250byB0aGVcbiAgICAvLyBwYXJ0cyBhcnJheSBhbmQgbGV0IHRoZSBydW50aW1lIHNlZSB0aGUgZGlmZmVyZW5jZS4gSG93ZXZlciwgd2UgY2Fubm90XG4gICAgLy8gc2ltcGx5IHVzZSB0aGUgc3RyaW5nIGB0aGlzYCBhcyBpdCBtZWFucyBsaXRlcmFsbHkgdGhlIHByb3BlcnR5IGNhbGxlZFxuICAgIC8vIFwidGhpc1wiIGluIHRoZSBjdXJyZW50IGNvbnRleHQgKGl0IGNhbiBiZSBleHByZXNzZWQgaW4gdGhlIHN5bnRheCBhc1xuICAgIC8vIGB7e1t0aGlzXX19YCwgd2hlcmUgdGhlIHNxdWFyZSBicmFja2V0IGFyZSBnZW5lcmFsbHkgZm9yIHRoaXMga2luZCBvZlxuICAgIC8vIGVzY2FwaW5nIOKAkyBzdWNoIGFzIGB7e2Zvby5bXCJiYXIuYmF6XCJdfX1gIHdvdWxkIG1lYW4gbG9va3VwIGEgcHJvcGVydHlcbiAgICAvLyBuYW1lZCBsaXRlcmFsbHkgXCJiYXIuYmF6XCIgb24gYHRoaXMuZm9vYCkuIEJ5IGNvbnZlbnRpb24sIHdlIHVzZSBgbnVsbGBcbiAgICAvLyBmb3IgdGhpcyBwdXJwb3NlLlxuICAgIGlmIChvcmlnaW5hbC5tYXRjaCgvXnRoaXMoXFwuLispPyQvKSkge1xuICAgICAgdGhpc0hlYWQgPSB0cnVlO1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICB0eXBlOiAnUGF0aEV4cHJlc3Npb24nLFxuICAgICAgb3JpZ2luYWw6IHBhdGgub3JpZ2luYWwsXG4gICAgICB0aGlzOiB0aGlzSGVhZCxcbiAgICAgIHBhcnRzLFxuICAgICAgZGF0YTogcGF0aC5kYXRhLFxuICAgICAgbG9jOiBwYXRoLmxvYyxcbiAgICB9O1xuICB9XG5cbiAgSGFzaChoYXNoOiBIYW5kbGViYXJzQVNULkhhc2gpOiBBU1QuSGFzaCB7XG4gICAgbGV0IHBhaXJzOiBBU1QuSGFzaFBhaXJbXSA9IFtdO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBoYXNoLnBhaXJzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBsZXQgcGFpciA9IGhhc2gucGFpcnNbaV07XG4gICAgICBwYWlycy5wdXNoKGIucGFpcihwYWlyLmtleSwgdGhpcy5hY2NlcHROb2RlPEFTVC5FeHByZXNzaW9uPihwYWlyLnZhbHVlKSwgcGFpci5sb2MpKTtcbiAgICB9XG5cbiAgICByZXR1cm4gYi5oYXNoKHBhaXJzLCBoYXNoLmxvYyk7XG4gIH1cblxuICBTdHJpbmdMaXRlcmFsKHN0cmluZzogSGFuZGxlYmFyc0FTVC5TdHJpbmdMaXRlcmFsKSB7XG4gICAgcmV0dXJuIGIubGl0ZXJhbCgnU3RyaW5nTGl0ZXJhbCcsIHN0cmluZy52YWx1ZSwgc3RyaW5nLmxvYyk7XG4gIH1cblxuICBCb29sZWFuTGl0ZXJhbChib29sZWFuOiBIYW5kbGViYXJzQVNULkJvb2xlYW5MaXRlcmFsKSB7XG4gICAgcmV0dXJuIGIubGl0ZXJhbCgnQm9vbGVhbkxpdGVyYWwnLCBib29sZWFuLnZhbHVlLCBib29sZWFuLmxvYyk7XG4gIH1cblxuICBOdW1iZXJMaXRlcmFsKG51bWJlcjogSGFuZGxlYmFyc0FTVC5OdW1iZXJMaXRlcmFsKSB7XG4gICAgcmV0dXJuIGIubGl0ZXJhbCgnTnVtYmVyTGl0ZXJhbCcsIG51bWJlci52YWx1ZSwgbnVtYmVyLmxvYyk7XG4gIH1cblxuICBVbmRlZmluZWRMaXRlcmFsKHVuZGVmOiBIYW5kbGViYXJzQVNULlVuZGVmaW5lZExpdGVyYWwpIHtcbiAgICByZXR1cm4gYi5saXRlcmFsKCdVbmRlZmluZWRMaXRlcmFsJywgdW5kZWZpbmVkLCB1bmRlZi5sb2MpO1xuICB9XG5cbiAgTnVsbExpdGVyYWwobnVsOiBIYW5kbGViYXJzQVNULk51bGxMaXRlcmFsKSB7XG4gICAgcmV0dXJuIGIubGl0ZXJhbCgnTnVsbExpdGVyYWwnLCBudWxsLCBudWwubG9jKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBjYWxjdWxhdGVSaWdodFN0cmlwcGVkT2Zmc2V0cyhvcmlnaW5hbDogc3RyaW5nLCB2YWx1ZTogc3RyaW5nKSB7XG4gIGlmICh2YWx1ZSA9PT0gJycpIHtcbiAgICAvLyBpZiBpdCBpcyBlbXB0eSwganVzdCByZXR1cm4gdGhlIGNvdW50IG9mIG5ld2xpbmVzXG4gICAgLy8gaW4gb3JpZ2luYWxcbiAgICByZXR1cm4ge1xuICAgICAgbGluZXM6IG9yaWdpbmFsLnNwbGl0KCdcXG4nKS5sZW5ndGggLSAxLFxuICAgICAgY29sdW1uczogMCxcbiAgICB9O1xuICB9XG5cbiAgLy8gb3RoZXJ3aXNlLCByZXR1cm4gdGhlIG51bWJlciBvZiBuZXdsaW5lcyBwcmlvciB0b1xuICAvLyBgdmFsdWVgXG4gIGxldCBkaWZmZXJlbmNlID0gb3JpZ2luYWwuc3BsaXQodmFsdWUpWzBdO1xuICBsZXQgbGluZXMgPSBkaWZmZXJlbmNlLnNwbGl0KC9cXG4vKTtcbiAgbGV0IGxpbmVDb3VudCA9IGxpbmVzLmxlbmd0aCAtIDE7XG5cbiAgcmV0dXJuIHtcbiAgICBsaW5lczogbGluZUNvdW50LFxuICAgIGNvbHVtbnM6IGxpbmVzW2xpbmVDb3VudF0ubGVuZ3RoLFxuICB9O1xufVxuXG5mdW5jdGlvbiB1cGRhdGVUb2tlbml6ZXJMb2NhdGlvbihcbiAgdG9rZW5pemVyOiBQYXJzZXJbJ3Rva2VuaXplciddLFxuICBjb250ZW50OiBIYW5kbGViYXJzQVNULkNvbnRlbnRTdGF0ZW1lbnRcbikge1xuICBsZXQgbGluZSA9IGNvbnRlbnQubG9jLnN0YXJ0LmxpbmU7XG4gIGxldCBjb2x1bW4gPSBjb250ZW50LmxvYy5zdGFydC5jb2x1bW47XG5cbiAgbGV0IG9mZnNldHMgPSBjYWxjdWxhdGVSaWdodFN0cmlwcGVkT2Zmc2V0cyhcbiAgICBjb250ZW50Lm9yaWdpbmFsIGFzIFJlY2FzdDxIYW5kbGViYXJzQVNULlN0cmlwRmxhZ3MsIHN0cmluZz4sXG4gICAgY29udGVudC52YWx1ZVxuICApO1xuXG4gIGxpbmUgPSBsaW5lICsgb2Zmc2V0cy5saW5lcztcbiAgaWYgKG9mZnNldHMubGluZXMpIHtcbiAgICBjb2x1bW4gPSBvZmZzZXRzLmNvbHVtbnM7XG4gIH0gZWxzZSB7XG4gICAgY29sdW1uID0gY29sdW1uICsgb2Zmc2V0cy5jb2x1bW5zO1xuICB9XG5cbiAgdG9rZW5pemVyLmxpbmUgPSBsaW5lO1xuICB0b2tlbml6ZXIuY29sdW1uID0gY29sdW1uO1xufVxuXG5mdW5jdGlvbiBhY2NlcHRDYWxsTm9kZXMoXG4gIGNvbXBpbGVyOiBIYW5kbGViYXJzTm9kZVZpc2l0b3JzLFxuICBub2RlOiB7XG4gICAgcGF0aDogSGFuZGxlYmFyc0FTVC5QYXRoRXhwcmVzc2lvbjtcbiAgICBwYXJhbXM6IEhhbmRsZWJhcnNBU1QuRXhwcmVzc2lvbltdO1xuICAgIGhhc2g6IEhhbmRsZWJhcnNBU1QuSGFzaDtcbiAgfVxuKTogeyBwYXRoOiBBU1QuUGF0aEV4cHJlc3Npb247IHBhcmFtczogQVNULkV4cHJlc3Npb25bXTsgaGFzaDogQVNULkhhc2ggfSB7XG4gIGxldCBwYXRoID0gY29tcGlsZXIuUGF0aEV4cHJlc3Npb24obm9kZS5wYXRoKTtcblxuICBsZXQgcGFyYW1zID0gbm9kZS5wYXJhbXMgPyBub2RlLnBhcmFtcy5tYXAoZSA9PiBjb21waWxlci5hY2NlcHROb2RlPEFTVC5FeHByZXNzaW9uPihlKSkgOiBbXTtcbiAgbGV0IGhhc2ggPSBub2RlLmhhc2ggPyBjb21waWxlci5IYXNoKG5vZGUuaGFzaCkgOiBiLmhhc2goKTtcblxuICByZXR1cm4geyBwYXRoLCBwYXJhbXMsIGhhc2ggfTtcbn1cblxuZnVuY3Rpb24gYWRkRWxlbWVudE1vZGlmaWVyKGVsZW1lbnQ6IFRhZzwnU3RhcnRUYWcnPiwgbXVzdGFjaGU6IEFTVC5NdXN0YWNoZVN0YXRlbWVudCkge1xuICBsZXQgeyBwYXRoLCBwYXJhbXMsIGhhc2gsIGxvYyB9ID0gbXVzdGFjaGU7XG5cbiAgaWYgKGlzTGl0ZXJhbChwYXRoKSkge1xuICAgIGxldCBtb2RpZmllciA9IGB7eyR7cHJpbnRMaXRlcmFsKHBhdGgpfX19YDtcbiAgICBsZXQgdGFnID0gYDwke2VsZW1lbnQubmFtZX0gLi4uICR7bW9kaWZpZXJ9IC4uLmA7XG5cbiAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoXG4gICAgICBgSW4gJHt0YWd9LCAke21vZGlmaWVyfSBpcyBub3QgYSB2YWxpZCBtb2RpZmllcjogXCIke3BhdGgub3JpZ2luYWx9XCIgb24gbGluZSAke2xvYyAmJlxuICAgICAgICBsb2Muc3RhcnQubGluZX0uYCxcbiAgICAgIG11c3RhY2hlLmxvY1xuICAgICk7XG4gIH1cblxuICBsZXQgbW9kaWZpZXIgPSBiLmVsZW1lbnRNb2RpZmllcihwYXRoLCBwYXJhbXMsIGhhc2gsIGxvYyk7XG4gIGVsZW1lbnQubW9kaWZpZXJzLnB1c2gobW9kaWZpZXIpO1xufVxuXG5mdW5jdGlvbiBhZGRJbkVsZW1lbnRIYXNoKGN1cnNvcjogc3RyaW5nLCBoYXNoOiBBU1QuSGFzaCwgbG9jOiBBU1QuU291cmNlTG9jYXRpb24pIHtcbiAgbGV0IGhhc05leHRTaWJsaW5nID0gZmFsc2U7XG4gIGhhc2gucGFpcnMuZm9yRWFjaChwYWlyID0+IHtcbiAgICBpZiAocGFpci5rZXkgPT09ICdndWlkJykge1xuICAgICAgdGhyb3cgbmV3IFN5bnRheEVycm9yKCdDYW5ub3QgcGFzcyBgZ3VpZGAgZnJvbSB1c2VyIHNwYWNlJywgbG9jKTtcbiAgICB9XG5cbiAgICBpZiAocGFpci5rZXkgPT09ICduZXh0U2libGluZycpIHtcbiAgICAgIGhhc05leHRTaWJsaW5nID0gdHJ1ZTtcbiAgICB9XG4gIH0pO1xuXG4gIGxldCBndWlkID0gYi5saXRlcmFsKCdTdHJpbmdMaXRlcmFsJywgY3Vyc29yKTtcbiAgbGV0IGd1aWRQYWlyID0gYi5wYWlyKCdndWlkJywgZ3VpZCk7XG4gIGhhc2gucGFpcnMudW5zaGlmdChndWlkUGFpcik7XG5cbiAgaWYgKCFoYXNOZXh0U2libGluZykge1xuICAgIGxldCBudWxsTGl0ZXJhbCA9IGIubGl0ZXJhbCgnTnVsbExpdGVyYWwnLCBudWxsKTtcbiAgICBsZXQgbmV4dFNpYmxpbmcgPSBiLnBhaXIoJ25leHRTaWJsaW5nJywgbnVsbExpdGVyYWwpO1xuICAgIGhhc2gucGFpcnMucHVzaChuZXh0U2libGluZyk7XG4gIH1cblxuICByZXR1cm4gaGFzaDtcbn1cblxuZnVuY3Rpb24gYXBwZW5kRHluYW1pY0F0dHJpYnV0ZVZhbHVlUGFydChhdHRyaWJ1dGU6IEF0dHJpYnV0ZSwgcGFydDogQVNULk11c3RhY2hlU3RhdGVtZW50KSB7XG4gIGF0dHJpYnV0ZS5pc0R5bmFtaWMgPSB0cnVlO1xuICBhdHRyaWJ1dGUucGFydHMucHVzaChwYXJ0KTtcbn1cbiJdfQ==