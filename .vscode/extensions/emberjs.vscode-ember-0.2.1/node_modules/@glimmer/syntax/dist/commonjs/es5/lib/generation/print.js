'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.default = build;

var _nodes = require('../types/nodes');

var HBS = _interopRequireWildcard(_nodes);

var _tokenizerEventHandlers = require('../parser/tokenizer-event-handlers');

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

function unreachable() {
    throw new Error('unreachable');
}
function build(ast) {
    if (!ast) {
        return '';
    }
    var output = [];
    switch (ast.type) {
        case 'Program':
            {
                var chainBlock = ast['chained'] && ast.body[0];
                if (chainBlock) {
                    chainBlock['chained'] = true;
                }
                var body = buildEach(ast.body).join('');
                output.push(body);
            }
            break;
        case 'ElementNode':
            output.push('<', ast.tag);
            if (ast.attributes.length) {
                output.push(' ', buildEach(ast.attributes).join(' '));
            }
            if (ast.modifiers.length) {
                output.push(' ', buildEach(ast.modifiers).join(' '));
            }
            if (ast.comments.length) {
                output.push(' ', buildEach(ast.comments).join(' '));
            }
            if (_tokenizerEventHandlers.voidMap[ast.tag]) {
                if (ast.selfClosing) {
                    output.push(' /');
                }
                output.push('>');
            } else {
                output.push('>');
                output.push.apply(output, buildEach(ast.children));
                output.push('</', ast.tag, '>');
            }
            break;
        case 'AttrNode':
            output.push(ast.name, '=');
            var value = build(ast.value);
            if (ast.value.type === 'TextNode') {
                output.push('"', value, '"');
            } else {
                output.push(value);
            }
            break;
        case 'ConcatStatement':
            output.push('"');
            ast.parts.forEach(function (node) {
                if (node.type === 'StringLiteral') {
                    output.push(node.original);
                } else {
                    output.push(build(node));
                }
            });
            output.push('"');
            break;
        case 'TextNode':
            output.push(ast.chars);
            break;
        case 'MustacheStatement':
            {
                output.push(compactJoin(['{{', pathParams(ast), '}}']));
            }
            break;
        case 'MustacheCommentStatement':
            {
                output.push(compactJoin(['{{!--', ast.value, '--}}']));
            }
            break;
        case 'ElementModifierStatement':
            {
                output.push(compactJoin(['{{', pathParams(ast), '}}']));
            }
            break;
        case 'PathExpression':
            output.push(ast.original);
            break;
        case 'SubExpression':
            {
                output.push('(', pathParams(ast), ')');
            }
            break;
        case 'BooleanLiteral':
            output.push(ast.value ? 'true' : 'false');
            break;
        case 'BlockStatement':
            {
                var lines = [];
                if (ast['chained']) {
                    lines.push(['{{else ', pathParams(ast), '}}'].join(''));
                } else {
                    lines.push(openBlock(ast));
                }
                lines.push(build(ast.program));
                if (ast.inverse) {
                    if (!ast.inverse['chained']) {
                        lines.push('{{else}}');
                    }
                    lines.push(build(ast.inverse));
                }
                if (!ast['chained']) {
                    lines.push(closeBlock(ast));
                }
                output.push(lines.join(''));
            }
            break;
        case 'PartialStatement':
            {
                output.push(compactJoin(['{{>', pathParams(ast), '}}']));
            }
            break;
        case 'CommentStatement':
            {
                output.push(compactJoin(['<!--', ast.value, '-->']));
            }
            break;
        case 'StringLiteral':
            {
                output.push('"' + ast.value + '"');
            }
            break;
        case 'NumberLiteral':
            {
                output.push(String(ast.value));
            }
            break;
        case 'UndefinedLiteral':
            {
                output.push('undefined');
            }
            break;
        case 'NullLiteral':
            {
                output.push('null');
            }
            break;
        case 'Hash':
            {
                output.push(ast.pairs.map(function (pair) {
                    return build(pair);
                }).join(' '));
            }
            break;
        case 'HashPair':
            {
                output.push(ast.key + '=' + build(ast.value));
            }
            break;
    }
    return output.join('');
}
function compact(array) {
    var newArray = [];
    array.forEach(function (a) {
        if (typeof a !== 'undefined' && a !== null && a !== '') {
            newArray.push(a);
        }
    });
    return newArray;
}
function buildEach(asts) {
    return asts.map(build);
}
function pathParams(ast) {
    var path = void 0;
    switch (ast.type) {
        case 'MustacheStatement':
        case 'SubExpression':
        case 'ElementModifierStatement':
        case 'BlockStatement':
            if (HBS.isLiteral(ast.path)) {
                return String(ast.path.value);
            }
            path = build(ast.path);
            break;
        case 'PartialStatement':
            path = build(ast.name);
            break;
        default:
            return unreachable();
    }
    return compactJoin([path, buildEach(ast.params).join(' '), build(ast.hash)], ' ');
}
function compactJoin(array, delimiter) {
    return compact(array).join(delimiter || '');
}
function blockParams(block) {
    var params = block.program.blockParams;
    if (params.length) {
        return ' as |' + params.join(' ') + '|';
    }
    return null;
}
function openBlock(block) {
    return ['{{#', pathParams(block), blockParams(block), '}}'].join('');
}
function closeBlock(block) {
    return ['{{/', build(block.path), '}}'].join('');
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJpbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9AZ2xpbW1lci9zeW50YXgvbGliL2dlbmVyYXRpb24vcHJpbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUNBLEFBQU87O0lBQUssQUFBRyxBQUFNLEFBQWdCLEFBQUM7O0FBQ3RDLEFBQU8sQUFBRSxBQUFPLEFBQUUsQUFBTSxBQUFvQyxBQUFDOzs7O0FBRTdELHVCQUNFO1VBQU0sSUFBSSxBQUFLLE1BQUMsQUFBYSxBQUFDLEFBQUMsQUFDakMsQUFBQztBQUVELEFBQU0sQUFBQyxBQUFPO2VBQWdCLEFBQWEsS0FDekM7UUFBSSxDQUFDLEFBQUcsS0FBRSxBQUNSO2VBQU8sQUFBRSxBQUFDLEFBQ1gsQUFDRDs7UUFBTSxBQUFNLFNBQWEsQUFBRSxBQUFDLEFBRTVCO1lBQVEsQUFBRyxJQUFDLEFBQUksQUFBRSxBQUNoQjthQUFLLEFBQVMsQUFDWixBQUNFOztvQkFBTSxBQUFVLGFBQUcsQUFBRyxJQUFDLEFBQVMsQUFBQyxjQUFJLEFBQUcsSUFBQyxBQUFJLEtBQUMsQUFBQyxBQUFDLEFBQUMsQUFDakQ7b0JBQUksQUFBVSxZQUFFLEFBQ2QsQUFBVTsrQkFBQyxBQUFTLEFBQUMsYUFBRyxBQUFJLEFBQUMsQUFDOUIsQUFDRDs7b0JBQU0sQUFBSSxPQUFHLEFBQVMsVUFBQyxBQUFHLElBQUMsQUFBSSxBQUFDLE1BQUMsQUFBSSxLQUFDLEFBQUUsQUFBQyxBQUFDLEFBQzFDLEFBQU07dUJBQUMsQUFBSSxLQUFDLEFBQUksQUFBQyxBQUFDLEFBQ25CLEFBQ0QsQUFBTTtBQUNSOzthQUFLLEFBQWEsQUFDaEIsQUFBTTttQkFBQyxBQUFJLEtBQUMsQUFBRyxLQUFFLEFBQUcsSUFBQyxBQUFHLEFBQUMsQUFBQyxBQUMxQjtnQkFBSSxBQUFHLElBQUMsQUFBVSxXQUFDLEFBQU0sUUFBRSxBQUN6QixBQUFNO3VCQUFDLEFBQUksS0FBQyxB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QUFJLEFBQUMsTUFBQyxBQUFJLEtBQUMsQUFBRSxBQUFDLEFBQUMsQUFDdkUsQUFBQzs7QUFFRCxvQkFBb0IsQUFBVSxPQUM1QjtXQUFPLENBQUMsQUFBSyxPQUFFLEFBQUssTUFBQyxBQUFLLE1BQUMsQUFBSSxBQUFDLE9BQUUsQUFBSSxBQUFDLE1BQUMsQUFBSSxLQUFDLEFBQUUsQUFBQyxBQUFDLEFBQ25ELEFBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBPcHRpb24gfSBmcm9tICdAZ2xpbW1lci9pbnRlcmZhY2VzJztcbmltcG9ydCAqIGFzIEhCUyBmcm9tICcuLi90eXBlcy9ub2Rlcyc7XG5pbXBvcnQgeyB2b2lkTWFwIH0gZnJvbSAnLi4vcGFyc2VyL3Rva2VuaXplci1ldmVudC1oYW5kbGVycyc7XG5cbmZ1bmN0aW9uIHVucmVhY2hhYmxlKCk6IG5ldmVyIHtcbiAgdGhyb3cgbmV3IEVycm9yKCd1bnJlYWNoYWJsZScpO1xufVxuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBidWlsZChhc3Q6IEhCUy5Ob2RlKTogc3RyaW5nIHtcbiAgaWYgKCFhc3QpIHtcbiAgICByZXR1cm4gJyc7XG4gIH1cbiAgY29uc3Qgb3V0cHV0OiBzdHJpbmdbXSA9IFtdO1xuXG4gIHN3aXRjaCAoYXN0LnR5cGUpIHtcbiAgICBjYXNlICdQcm9ncmFtJzpcbiAgICAgIHtcbiAgICAgICAgY29uc3QgY2hhaW5CbG9jayA9IGFzdFsnY2hhaW5lZCddICYmIGFzdC5ib2R5WzBdO1xuICAgICAgICBpZiAoY2hhaW5CbG9jaykge1xuICAgICAgICAgIGNoYWluQmxvY2tbJ2NoYWluZWQnXSA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgYm9keSA9IGJ1aWxkRWFjaChhc3QuYm9keSkuam9pbignJyk7XG4gICAgICAgIG91dHB1dC5wdXNoKGJvZHkpO1xuICAgICAgfVxuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnRWxlbWVudE5vZGUnOlxuICAgICAgb3V0cHV0LnB1c2goJzwnLCBhc3QudGFnKTtcbiAgICAgIGlmIChhc3QuYXR0cmlidXRlcy5sZW5ndGgpIHtcbiAgICAgICAgb3V0cHV0LnB1c2goJyAnLCBidWlsZEVhY2goYXN0LmF0dHJpYnV0ZXMpLmpvaW4oJyAnKSk7XG4gICAgICB9XG4gICAgICBpZiAoYXN0Lm1vZGlmaWVycy5sZW5ndGgpIHtcbiAgICAgICAgb3V0cHV0LnB1c2goJyAnLCBidWlsZEVhY2goYXN0Lm1vZGlmaWVycykuam9pbignICcpKTtcbiAgICAgIH1cbiAgICAgIGlmIChhc3QuY29tbWVudHMubGVuZ3RoKSB7XG4gICAgICAgIG91dHB1dC5wdXNoKCcgJywgYnVpbGRFYWNoKGFzdC5jb21tZW50cykuam9pbignICcpKTtcbiAgICAgIH1cblxuICAgICAgaWYgKHZvaWRNYXBbYXN0LnRhZ10pIHtcbiAgICAgICAgaWYgKGFzdC5zZWxmQ2xvc2luZykge1xuICAgICAgICAgIG91dHB1dC5wdXNoKCcgLycpO1xuICAgICAgICB9XG5cbiAgICAgICAgb3V0cHV0LnB1c2goJz4nKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG91dHB1dC5wdXNoKCc+Jyk7XG4gICAgICAgIG91dHB1dC5wdXNoLmFwcGx5KG91dHB1dCwgYnVpbGRFYWNoKGFzdC5jaGlsZHJlbikpO1xuICAgICAgICBvdXRwdXQucHVzaCgnPC8nLCBhc3QudGFnLCAnPicpO1xuICAgICAgfVxuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnQXR0ck5vZGUnOlxuICAgICAgb3V0cHV0LnB1c2goYXN0Lm5hbWUsICc9Jyk7XG4gICAgICBjb25zdCB2YWx1ZSA9IGJ1aWxkKGFzdC52YWx1ZSk7XG4gICAgICBpZiAoYXN0LnZhbHVlLnR5cGUgPT09ICdUZXh0Tm9kZScpIHtcbiAgICAgICAgb3V0cHV0LnB1c2goJ1wiJywgdmFsdWUsICdcIicpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgb3V0cHV0LnB1c2godmFsdWUpO1xuICAgICAgfVxuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnQ29uY2F0U3RhdGVtZW50JzpcbiAgICAgIG91dHB1dC5wdXNoKCdcIicpO1xuICAgICAgYXN0LnBhcnRzLmZvckVhY2goKG5vZGU6IGFueSkgPT4ge1xuICAgICAgICBpZiAobm9kZS50eXBlID09PSAnU3RyaW5nTGl0ZXJhbCcpIHtcbiAgICAgICAgICBvdXRwdXQucHVzaChub2RlLm9yaWdpbmFsKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBvdXRwdXQucHVzaChidWlsZChub2RlKSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgb3V0cHV0LnB1c2goJ1wiJyk7XG4gICAgICBicmVhaztcbiAgICBjYXNlICdUZXh0Tm9kZSc6XG4gICAgICBvdXRwdXQucHVzaChhc3QuY2hhcnMpO1xuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnTXVzdGFjaGVTdGF0ZW1lbnQnOlxuICAgICAge1xuICAgICAgICBvdXRwdXQucHVzaChjb21wYWN0Sm9pbihbJ3t7JywgcGF0aFBhcmFtcyhhc3QpLCAnfX0nXSkpO1xuICAgICAgfVxuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnTXVzdGFjaGVDb21tZW50U3RhdGVtZW50JzpcbiAgICAgIHtcbiAgICAgICAgb3V0cHV0LnB1c2goY29tcGFjdEpvaW4oWyd7eyEtLScsIGFzdC52YWx1ZSwgJy0tfX0nXSkpO1xuICAgICAgfVxuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnRWxlbWVudE1vZGlmaWVyU3RhdGVtZW50JzpcbiAgICAgIHtcbiAgICAgICAgb3V0cHV0LnB1c2goY29tcGFjdEpvaW4oWyd7eycsIHBhdGhQYXJhbXMoYXN0KSwgJ319J10pKTtcbiAgICAgIH1cbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ1BhdGhFeHByZXNzaW9uJzpcbiAgICAgIG91dHB1dC5wdXNoKGFzdC5vcmlnaW5hbCk7XG4gICAgICBicmVhaztcbiAgICBjYXNlICdTdWJFeHByZXNzaW9uJzpcbiAgICAgIHtcbiAgICAgICAgb3V0cHV0LnB1c2goJygnLCBwYXRoUGFyYW1zKGFzdCksICcpJyk7XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgICBjYXNlICdCb29sZWFuTGl0ZXJhbCc6XG4gICAgICBvdXRwdXQucHVzaChhc3QudmFsdWUgPyAndHJ1ZScgOiAnZmFsc2UnKTtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ0Jsb2NrU3RhdGVtZW50JzpcbiAgICAgIHtcbiAgICAgICAgY29uc3QgbGluZXM6IHN0cmluZ1tdID0gW107XG5cbiAgICAgICAgaWYgKGFzdFsnY2hhaW5lZCddKSB7XG4gICAgICAgICAgbGluZXMucHVzaChbJ3t7ZWxzZSAnLCBwYXRoUGFyYW1zKGFzdCksICd9fSddLmpvaW4oJycpKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBsaW5lcy5wdXNoKG9wZW5CbG9jayhhc3QpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxpbmVzLnB1c2goYnVpbGQoYXN0LnByb2dyYW0pKTtcblxuICAgICAgICBpZiAoYXN0LmludmVyc2UpIHtcbiAgICAgICAgICBpZiAoIWFzdC5pbnZlcnNlWydjaGFpbmVkJ10pIHtcbiAgICAgICAgICAgIGxpbmVzLnB1c2goJ3t7ZWxzZX19Jyk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGxpbmVzLnB1c2goYnVpbGQoYXN0LmludmVyc2UpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghYXN0WydjaGFpbmVkJ10pIHtcbiAgICAgICAgICBsaW5lcy5wdXNoKGNsb3NlQmxvY2soYXN0KSk7XG4gICAgICAgIH1cblxuICAgICAgICBvdXRwdXQucHVzaChsaW5lcy5qb2luKCcnKSk7XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgICBjYXNlICdQYXJ0aWFsU3RhdGVtZW50JzpcbiAgICAgIHtcbiAgICAgICAgb3V0cHV0LnB1c2goY29tcGFjdEpvaW4oWyd7ez4nLCBwYXRoUGFyYW1zKGFzdCksICd9fSddKSk7XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgICBjYXNlICdDb21tZW50U3RhdGVtZW50JzpcbiAgICAgIHtcbiAgICAgICAgb3V0cHV0LnB1c2goY29tcGFjdEpvaW4oWyc8IS0tJywgYXN0LnZhbHVlLCAnLS0+J10pKTtcbiAgICAgIH1cbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ1N0cmluZ0xpdGVyYWwnOlxuICAgICAge1xuICAgICAgICBvdXRwdXQucHVzaChgXCIke2FzdC52YWx1ZX1cImApO1xuICAgICAgfVxuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnTnVtYmVyTGl0ZXJhbCc6XG4gICAgICB7XG4gICAgICAgIG91dHB1dC5wdXNoKFN0cmluZyhhc3QudmFsdWUpKTtcbiAgICAgIH1cbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ1VuZGVmaW5lZExpdGVyYWwnOlxuICAgICAge1xuICAgICAgICBvdXRwdXQucHVzaCgndW5kZWZpbmVkJyk7XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgICBjYXNlICdOdWxsTGl0ZXJhbCc6XG4gICAgICB7XG4gICAgICAgIG91dHB1dC5wdXNoKCdudWxsJyk7XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgICBjYXNlICdIYXNoJzpcbiAgICAgIHtcbiAgICAgICAgb3V0cHV0LnB1c2goXG4gICAgICAgICAgYXN0LnBhaXJzXG4gICAgICAgICAgICAubWFwKHBhaXIgPT4ge1xuICAgICAgICAgICAgICByZXR1cm4gYnVpbGQocGFpcik7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLmpvaW4oJyAnKVxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnSGFzaFBhaXInOlxuICAgICAge1xuICAgICAgICBvdXRwdXQucHVzaChgJHthc3Qua2V5fT0ke2J1aWxkKGFzdC52YWx1ZSl9YCk7XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgfVxuICByZXR1cm4gb3V0cHV0LmpvaW4oJycpO1xufVxuXG5mdW5jdGlvbiBjb21wYWN0KGFycmF5OiBPcHRpb248c3RyaW5nPltdKTogc3RyaW5nW10ge1xuICBjb25zdCBuZXdBcnJheTogYW55W10gPSBbXTtcbiAgYXJyYXkuZm9yRWFjaChhID0+IHtcbiAgICBpZiAodHlwZW9mIGEgIT09ICd1bmRlZmluZWQnICYmIGEgIT09IG51bGwgJiYgYSAhPT0gJycpIHtcbiAgICAgIG5ld0FycmF5LnB1c2goYSk7XG4gICAgfVxuICB9KTtcbiAgcmV0dXJuIG5ld0FycmF5O1xufVxuXG5mdW5jdGlvbiBidWlsZEVhY2goYXN0czogSEJTLk5vZGVbXSk6IHN0cmluZ1tdIHtcbiAgcmV0dXJuIGFzdHMubWFwKGJ1aWxkKTtcbn1cblxuZnVuY3Rpb24gcGF0aFBhcmFtcyhhc3Q6IEhCUy5Ob2RlKTogc3RyaW5nIHtcbiAgbGV0IHBhdGg6IHN0cmluZztcblxuICBzd2l0Y2ggKGFzdC50eXBlKSB7XG4gICAgY2FzZSAnTXVzdGFjaGVTdGF0ZW1lbnQnOlxuICAgIGNhc2UgJ1N1YkV4cHJlc3Npb24nOlxuICAgIGNhc2UgJ0VsZW1lbnRNb2RpZmllclN0YXRlbWVudCc6XG4gICAgY2FzZSAnQmxvY2tTdGF0ZW1lbnQnOlxuICAgICAgaWYgKEhCUy5pc0xpdGVyYWwoYXN0LnBhdGgpKSB7XG4gICAgICAgIHJldHVybiBTdHJpbmcoYXN0LnBhdGgudmFsdWUpO1xuICAgICAgfVxuXG4gICAgICBwYXRoID0gYnVpbGQoYXN0LnBhdGgpO1xuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnUGFydGlhbFN0YXRlbWVudCc6XG4gICAgICBwYXRoID0gYnVpbGQoYXN0Lm5hbWUpO1xuICAgICAgYnJlYWs7XG4gICAgZGVmYXVsdDpcbiAgICAgIHJldHVybiB1bnJlYWNoYWJsZSgpO1xuICB9XG5cbiAgcmV0dXJuIGNvbXBhY3RKb2luKFtwYXRoLCBidWlsZEVhY2goYXN0LnBhcmFtcykuam9pbignICcpLCBidWlsZChhc3QuaGFzaCldLCAnICcpO1xufVxuXG5mdW5jdGlvbiBjb21wYWN0Sm9pbihhcnJheTogT3B0aW9uPHN0cmluZz5bXSwgZGVsaW1pdGVyPzogc3RyaW5nKTogc3RyaW5nIHtcbiAgcmV0dXJuIGNvbXBhY3QoYXJyYXkpLmpvaW4oZGVsaW1pdGVyIHx8ICcnKTtcbn1cblxuZnVuY3Rpb24gYmxvY2tQYXJhbXMoYmxvY2s6IEhCUy5CbG9ja1N0YXRlbWVudCk6IE9wdGlvbjxzdHJpbmc+IHtcbiAgY29uc3QgcGFyYW1zID0gYmxvY2sucHJvZ3JhbS5ibG9ja1BhcmFtcztcbiAgaWYgKHBhcmFtcy5sZW5ndGgpIHtcbiAgICByZXR1cm4gYCBhcyB8JHtwYXJhbXMuam9pbignICcpfXxgO1xuICB9XG5cbiAgcmV0dXJuIG51bGw7XG59XG5cbmZ1bmN0aW9uIG9wZW5CbG9jayhibG9jazogSEJTLkJsb2NrU3RhdGVtZW50KTogc3RyaW5nIHtcbiAgcmV0dXJuIFsne3sjJywgcGF0aFBhcmFtcyhibG9jayksIGJsb2NrUGFyYW1zKGJsb2NrKSwgJ319J10uam9pbignJyk7XG59XG5cbmZ1bmN0aW9uIGNsb3NlQmxvY2soYmxvY2s6IGFueSk6IHN0cmluZyB7XG4gIHJldHVybiBbJ3t7LycsIGJ1aWxkKGJsb2NrLnBhdGgpLCAnfX0nXS5qb2luKCcnKTtcbn1cbiJdfQ==