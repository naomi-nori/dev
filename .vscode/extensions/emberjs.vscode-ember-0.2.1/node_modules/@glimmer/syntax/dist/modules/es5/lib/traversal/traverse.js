import visitorKeys from '../types/visitor-keys';
import { cannotRemoveNode, cannotReplaceNode, cannotReplaceOrRemoveInKeyHandlerYet } from './errors';
function visitNode(visitor, node) {
    var handler = visitor[node.type] || visitor.All || null;
    var result = void 0;
    if (handler && handler['enter']) {
        result = handler['enter'].call(null, node);
    }
    if (result !== undefined && result !== null) {
        if (JSON.stringify(node) === JSON.stringify(result)) {
            result = undefined;
        } else if (Array.isArray(result)) {
            return visitArray(visitor, result) || result;
        } else {
            return visitNode(visitor, result) || result;
        }
    }
    if (result === undefined) {
        var keys = visitorKeys[node.type];
        for (var i = 0; i < keys.length; i++) {
            visitKey(visitor, handler, node, keys[i]);
        }
        if (handler && handler['exit']) {
            result = handler['exit'].call(null, node);
        }
    }
    return result;
}
function visitKey(visitor, handler, node, key) {
    var value = node[key];
    if (!value) {
        return;
    }
    var keyHandler = handler && (handler.keys[key] || handler.keys.All);
    var result = void 0;
    if (keyHandler && keyHandler.enter) {
        result = keyHandler.enter.call(null, node, key);
        if (result !== undefined) {
            throw cannotReplaceOrRemoveInKeyHandlerYet(node, key);
        }
    }
    if (Array.isArray(value)) {
        visitArray(visitor, value);
    } else {
        var _result = visitNode(visitor, value);
        if (_result !== undefined) {
            assignKey(node, key, _result);
        }
    }
    if (keyHandler && keyHandler.exit) {
        result = keyHandler.exit.call(null, node, key);
        if (result !== undefined) {
            throw cannotReplaceOrRemoveInKeyHandlerYet(node, key);
        }
    }
}
function visitArray(visitor, array) {
    for (var i = 0; i < array.length; i++) {
        var result = visitNode(visitor, array[i]);
        if (result !== undefined) {
            i += spliceArray(array, i, result) - 1;
        }
    }
}
function assignKey(node, key, result) {
    if (result === null) {
        throw cannotRemoveNode(node[key], node, key);
    } else if (Array.isArray(result)) {
        if (result.length === 1) {
            node[key] = result[0];
        } else {
            if (result.length === 0) {
                throw cannotRemoveNode(node[key], node, key);
            } else {
                throw cannotReplaceNode(node[key], node, key);
            }
        }
    } else {
        node[key] = result;
    }
}
function spliceArray(array, index, result) {
    if (result === null) {
        array.splice(index, 1);
        return 0;
    } else if (Array.isArray(result)) {
        array.splice.apply(array, [index, 1].concat(result));
        return result.length;
    } else {
        array.splice(index, 1, result);
        return 1;
    }
}
export default function traverse(node, visitor) {
    visitNode(normalizeVisitor(visitor), node);
}
export function normalizeVisitor(visitor) {
    var normalizedVisitor = {};
    for (var type in visitor) {
        var handler = visitor[type] || visitor.All;
        var normalizedKeys = {};
        if (typeof handler === 'object') {
            var keys = handler.keys;
            if (keys) {
                for (var key in keys) {
                    var keyHandler = keys[key];
                    if (typeof keyHandler === 'object') {
                        normalizedKeys[key] = {
                            enter: typeof keyHandler.enter === 'function' ? keyHandler.enter : null,
                            exit: typeof keyHandler.exit === 'function' ? keyHandler.exit : null
                        };
                    } else if (typeof keyHandler === 'function') {
                        normalizedKeys[key] = {
                            enter: keyHandler,
                            exit: null
                        };
                    }
                }
            }
            normalizedVisitor[type] = {
                enter: typeof handler.enter === 'function' ? handler.enter : null,
                exit: typeof handler.exit === 'function' ? handler.exit : null,
                keys: normalizedKeys
            };
        } else if (typeof handler === 'function') {
            normalizedVisitor[type] = {
                enter: handler,
                exit: null,
                keys: normalizedKeys
            };
        }
    }
    return normalizedVisitor;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhdmVyc2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9AZ2xpbW1lci9zeW50YXgvbGliL3RyYXZlcnNhbC90cmF2ZXJzZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEFBQVcsaUJBQU0sQUFBdUIsQUFBQztBQUNoRCxBQUFPLFNBQ0wsQUFBZ0Isa0JBQ2hCLEFBQWlCLG1CQUNqQixBQUFvQyxBQUNyQyw0Q0FBTSxBQUFVLEFBQUM7QUFxQmxCLG1CQUFtQixBQUFvQixTQUFFLEFBQWdCLE1BQ3ZEO1FBQUksQUFBTyxVQUFHLEFBQU8sUUFBQyxBQUFJLEtBQUMsQUFBSSxBQUFDLFNBQUksQUFBTyxRQUFDLEFBQUcsT0FBSSxBQUFJLEFBQUMsQUFDeEQ7UUFBSSxBQUFNLEFBQUMsQUFFWDtRQUFJLEFBQU8sV0FBSSxBQUFPLFFBQUMsQUFBTyxBQUFDLFVBQUUsQUFDL0IsQUFBTTtpQkFBRyxBQUFPLFFBQUMsQUFBTyxBQUFDLFNBQUMsQUFBSSxLQUFDLEFBQUksTUFBRSxBQUFJLEFBQUMsQUFBQyxBQUM1QztBQUVEO1FBQUksQUFBTSxXQUFLLEFBQVMsYUFBSSxBQUFNLFdBQUssQUFBSSxNQUFFLEFBQzNDO1lBQUksQUFBSSxLQUFDLEFBQVMsVUFBQyxBQUFJLEFBQUMsVUFBSyxBQUFJLEtBQUMsQUFBUyxVQUFDLEFBQU0sQUFBQyxTQUFFLEFBQ25ELEFBQU07cUJBQUcsQUFBUyxBQUFDLEFBQ3BCO21CQUFVLEFBQUssTUFBQyxBQUFPLFFBQUMsQUFBTSxBQUFDLFNBQUUsQUFDaEM7bUJBQU8sQUFBVSxXQUFDLEFBQU8sU0FBRSxBQUFNLEFBQUMsV0FBSSxBQUFNLEFBQUMsQUFDOUM7QUFGTSxlQUVBLEFBQ0w7bUJBQU8sQUFBUyxVQUFDLEFBQU8sU0FBRSxBQUFNLEFBQUMsV0FBSSxBQUFNLEFBQUMsQUFDN0M7QUFDRjtBQUVEO1FBQUksQUFBTSxXQUFLLEFBQVMsV0FBRSxBQUN4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QUFDLEFBQUssQUFBQyxBQUFDLFFBQUMsQUFBSSxBQUNqRSxBQUFJO3NCQUFFLE9BQU8sQUFBTyxRQUFDLEFBQUksU0FBSyxBQUFVLEFBQUMsQUFBQyxhQUFDLEFBQU8sUUFBQyxBQUFJLEFBQUMsQUFBQyxPQUFDLEFBQUksQUFDOUQsQUFBSTtzQkFIb0IsQUFHbEIsQUFBYyxBQUNyQixBQUFDLEFBQ0g7QUFKRyxBQUFLO2VBSUYsSUFBSSxPQUFPLEFBQU8sWUFBSyxBQUFVLFlBQUUsQUFDeEMsQUFBaUI7OEJBQUMsQUFBSSxBQUFDO3VCQUNkLEFBQU8sQUFDZCxBQUFJO3NCQUFFLEFBQUksQUFDVixBQUFJO3NCQUhvQixBQUdsQixBQUFjLEFBQ3JCLEFBQUMsQUFDSDtBQUpHLEFBQUs7QUFLVjtBQUVEO1dBQU8sQUFBaUIsQUFBQyxBQUMzQixBQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHZpc2l0b3JLZXlzIGZyb20gJy4uL3R5cGVzL3Zpc2l0b3Ita2V5cyc7XG5pbXBvcnQge1xuICBjYW5ub3RSZW1vdmVOb2RlLFxuICBjYW5ub3RSZXBsYWNlTm9kZSxcbiAgY2Fubm90UmVwbGFjZU9yUmVtb3ZlSW5LZXlIYW5kbGVyWWV0LFxufSBmcm9tICcuL2Vycm9ycyc7XG5pbXBvcnQgKiBhcyBub2RlcyBmcm9tICcuLi90eXBlcy9ub2Rlcyc7XG5cbmV4cG9ydCB0eXBlIE5vZGVIYW5kbGVyPFQgZXh0ZW5kcyBub2Rlcy5Ob2RlPiA9IE5vZGVIYW5kbGVyRnVuY3Rpb248VD4gfCBFbnRlckV4aXROb2RlSGFuZGxlcjxUPjtcblxuZXhwb3J0IHR5cGUgU3BlY2lmaWNOb2RlVmlzaXRvciA9IHsgW1AgaW4ga2V5b2Ygbm9kZXMuTm9kZXNdPzogTm9kZUhhbmRsZXI8bm9kZXMuTm9kZXNbUF0+IH07XG5cbmV4cG9ydCBpbnRlcmZhY2UgTm9kZVZpc2l0b3IgZXh0ZW5kcyBTcGVjaWZpY05vZGVWaXNpdG9yIHtcbiAgQWxsPzogTm9kZUhhbmRsZXI8bm9kZXMuTm9kZT47XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgTm9kZUhhbmRsZXJGdW5jdGlvbjxUIGV4dGVuZHMgbm9kZXMuTm9kZT4ge1xuICAodGhpczogbnVsbCwgbm9kZTogVCk6IGFueSB8IG51bGwgfCB1bmRlZmluZWQ7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRW50ZXJFeGl0Tm9kZUhhbmRsZXI8VCBleHRlbmRzIG5vZGVzLk5vZGU+IHtcbiAgZW50ZXI/OiBOb2RlSGFuZGxlckZ1bmN0aW9uPFQ+O1xuICBleGl0PzogTm9kZUhhbmRsZXJGdW5jdGlvbjxUPjtcbiAga2V5cz86IGFueTtcbn1cblxuZnVuY3Rpb24gdmlzaXROb2RlKHZpc2l0b3I6IE5vZGVWaXNpdG9yLCBub2RlOiBub2Rlcy5Ob2RlKTogYW55IHtcbiAgbGV0IGhhbmRsZXIgPSB2aXNpdG9yW25vZGUudHlwZV0gfHwgdmlzaXRvci5BbGwgfHwgbnVsbDtcbiAgbGV0IHJlc3VsdDtcblxuICBpZiAoaGFuZGxlciAmJiBoYW5kbGVyWydlbnRlciddKSB7XG4gICAgcmVzdWx0ID0gaGFuZGxlclsnZW50ZXInXS5jYWxsKG51bGwsIG5vZGUpO1xuICB9XG5cbiAgaWYgKHJlc3VsdCAhPT0gdW5kZWZpbmVkICYmIHJlc3VsdCAhPT0gbnVsbCkge1xuICAgIGlmIChKU09OLnN0cmluZ2lmeShub2RlKSA9PT0gSlNPTi5zdHJpbmdpZnkocmVzdWx0KSkge1xuICAgICAgcmVzdWx0ID0gdW5kZWZpbmVkO1xuICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShyZXN1bHQpKSB7XG4gICAgICByZXR1cm4gdmlzaXRBcnJheSh2aXNpdG9yLCByZXN1bHQpIHx8IHJlc3VsdDtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHZpc2l0Tm9kZSh2aXNpdG9yLCByZXN1bHQpIHx8IHJlc3VsdDtcbiAgICB9XG4gIH1cblxuICBpZiAocmVzdWx0ID09PSB1bmRlZmluZWQpIHtcbiAgICBsZXQga2V5cyA9IHZpc2l0b3JLZXlzW25vZGUudHlwZV07XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHtcbiAgICAgIHZpc2l0S2V5KHZpc2l0b3IsIGhhbmRsZXIgYXMgYW55LCBub2RlIGFzIGFueSwga2V5c1tpXSk7XG4gICAgfVxuXG4gICAgaWYgKGhhbmRsZXIgJiYgaGFuZGxlclsnZXhpdCddKSB7XG4gICAgICByZXN1bHQgPSBoYW5kbGVyWydleGl0J10uY2FsbChudWxsLCBub2RlKTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gcmVzdWx0O1xufVxuXG5mdW5jdGlvbiB2aXNpdEtleShcbiAgdmlzaXRvcjogTm9kZVZpc2l0b3IsXG4gIGhhbmRsZXI6IEVudGVyRXhpdE5vZGVIYW5kbGVyPG5vZGVzLk5vZGU+LFxuICBub2RlOiBub2Rlcy5Ob2RlICYgVHJhdmVyc2VkTm9kZSxcbiAga2V5OiBzdHJpbmdcbikge1xuICBsZXQgdmFsdWUgPSBub2RlW2tleV07XG4gIGlmICghdmFsdWUpIHtcbiAgICByZXR1cm47XG4gIH1cblxuICBsZXQga2V5SGFuZGxlciA9IGhhbmRsZXIgJiYgKGhhbmRsZXIua2V5c1trZXldIHx8IGhhbmRsZXIua2V5cy5BbGwpO1xuICBsZXQgcmVzdWx0O1xuXG4gIGlmIChrZXlIYW5kbGVyICYmIGtleUhhbmRsZXIuZW50ZXIpIHtcbiAgICByZXN1bHQgPSBrZXlIYW5kbGVyLmVudGVyLmNhbGwobnVsbCwgbm9kZSwga2V5KTtcbiAgICBpZiAocmVzdWx0ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHRocm93IGNhbm5vdFJlcGxhY2VPclJlbW92ZUluS2V5SGFuZGxlcllldChub2RlLCBrZXkpO1xuICAgIH1cbiAgfVxuXG4gIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkge1xuICAgIHZpc2l0QXJyYXkodmlzaXRvciwgdmFsdWUpO1xuICB9IGVsc2Uge1xuICAgIGxldCByZXN1bHQgPSB2aXNpdE5vZGUodmlzaXRvciwgdmFsdWUpO1xuICAgIGlmIChyZXN1bHQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgYXNzaWduS2V5KG5vZGUsIGtleSwgcmVzdWx0KTtcbiAgICB9XG4gIH1cblxuICBpZiAoa2V5SGFuZGxlciAmJiBrZXlIYW5kbGVyLmV4aXQpIHtcbiAgICByZXN1bHQgPSBrZXlIYW5kbGVyLmV4aXQuY2FsbChudWxsLCBub2RlLCBrZXkpO1xuICAgIGlmIChyZXN1bHQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhyb3cgY2Fubm90UmVwbGFjZU9yUmVtb3ZlSW5LZXlIYW5kbGVyWWV0KG5vZGUsIGtleSk7XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIHZpc2l0QXJyYXkodmlzaXRvcjogTm9kZVZpc2l0b3IsIGFycmF5OiBub2Rlcy5Ob2RlW10pIHtcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcnJheS5sZW5ndGg7IGkrKykge1xuICAgIGxldCByZXN1bHQgPSB2aXNpdE5vZGUodmlzaXRvciwgYXJyYXlbaV0pO1xuICAgIGlmIChyZXN1bHQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgaSArPSBzcGxpY2VBcnJheShhcnJheSwgaSwgcmVzdWx0KSAtIDE7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgVHJhdmVyc2VkTm9kZSB7XG4gIFtrZXk6IHN0cmluZ106IG5vZGVzLk5vZGU7XG59XG5cbmZ1bmN0aW9uIGFzc2lnbktleShub2RlOiBUcmF2ZXJzZWROb2RlICYgbm9kZXMuTm9kZSwga2V5OiBzdHJpbmcsIHJlc3VsdDogbm9kZXMuTm9kZSkge1xuICBpZiAocmVzdWx0ID09PSBudWxsKSB7XG4gICAgdGhyb3cgY2Fubm90UmVtb3ZlTm9kZShub2RlW2tleV0sIG5vZGUsIGtleSk7XG4gIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShyZXN1bHQpKSB7XG4gICAgaWYgKHJlc3VsdC5sZW5ndGggPT09IDEpIHtcbiAgICAgIG5vZGVba2V5XSA9IHJlc3VsdFswXTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHJlc3VsdC5sZW5ndGggPT09IDApIHtcbiAgICAgICAgdGhyb3cgY2Fubm90UmVtb3ZlTm9kZShub2RlW2tleV0sIG5vZGUsIGtleSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBjYW5ub3RSZXBsYWNlTm9kZShub2RlW2tleV0sIG5vZGUsIGtleSk7XG4gICAgICB9XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIG5vZGVba2V5XSA9IHJlc3VsdDtcbiAgfVxufVxuXG5mdW5jdGlvbiBzcGxpY2VBcnJheTxUPihhcnJheTogVFtdLCBpbmRleDogbnVtYmVyLCByZXN1bHQ6IFRbXSkge1xuICBpZiAocmVzdWx0ID09PSBudWxsKSB7XG4gICAgYXJyYXkuc3BsaWNlKGluZGV4LCAxKTtcbiAgICByZXR1cm4gMDtcbiAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KHJlc3VsdCkpIHtcbiAgICBhcnJheS5zcGxpY2UoaW5kZXgsIDEsIC4uLnJlc3VsdCk7XG4gICAgcmV0dXJuIHJlc3VsdC5sZW5ndGg7XG4gIH0gZWxzZSB7XG4gICAgYXJyYXkuc3BsaWNlKGluZGV4LCAxLCByZXN1bHQpO1xuICAgIHJldHVybiAxO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIHRyYXZlcnNlKG5vZGU6IG5vZGVzLk5vZGUsIHZpc2l0b3I6IE5vZGVWaXNpdG9yKSB7XG4gIHZpc2l0Tm9kZShub3JtYWxpemVWaXNpdG9yKHZpc2l0b3IpLCBub2RlKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG5vcm1hbGl6ZVZpc2l0b3IodmlzaXRvcjogTm9kZVZpc2l0b3IpIHtcbiAgbGV0IG5vcm1hbGl6ZWRWaXNpdG9yID0ge307XG5cbiAgZm9yIChsZXQgdHlwZSBpbiB2aXNpdG9yKSB7XG4gICAgbGV0IGhhbmRsZXIgPSB2aXNpdG9yW3R5cGVdIHx8IHZpc2l0b3IuQWxsO1xuICAgIGxldCBub3JtYWxpemVkS2V5cyA9IHt9O1xuXG4gICAgaWYgKHR5cGVvZiBoYW5kbGVyID09PSAnb2JqZWN0Jykge1xuICAgICAgbGV0IGtleXMgPSBoYW5kbGVyLmtleXM7XG4gICAgICBpZiAoa2V5cykge1xuICAgICAgICBmb3IgKGxldCBrZXkgaW4ga2V5cykge1xuICAgICAgICAgIGxldCBrZXlIYW5kbGVyID0ga2V5c1trZXldO1xuICAgICAgICAgIGlmICh0eXBlb2Yga2V5SGFuZGxlciA9PT0gJ29iamVjdCcpIHtcbiAgICAgICAgICAgIG5vcm1hbGl6ZWRLZXlzW2tleV0gPSB7XG4gICAgICAgICAgICAgIGVudGVyOiB0eXBlb2Yga2V5SGFuZGxlci5lbnRlciA9PT0gJ2Z1bmN0aW9uJyA/IGtleUhhbmRsZXIuZW50ZXIgOiBudWxsLFxuICAgICAgICAgICAgICBleGl0OiB0eXBlb2Yga2V5SGFuZGxlci5leGl0ID09PSAnZnVuY3Rpb24nID8ga2V5SGFuZGxlci5leGl0IDogbnVsbCxcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2Yga2V5SGFuZGxlciA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgbm9ybWFsaXplZEtleXNba2V5XSA9IHtcbiAgICAgICAgICAgICAgZW50ZXI6IGtleUhhbmRsZXIsXG4gICAgICAgICAgICAgIGV4aXQ6IG51bGwsXG4gICAgICAgICAgICB9O1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBub3JtYWxpemVkVmlzaXRvclt0eXBlXSA9IHtcbiAgICAgICAgZW50ZXI6IHR5cGVvZiBoYW5kbGVyLmVudGVyID09PSAnZnVuY3Rpb24nID8gaGFuZGxlci5lbnRlciA6IG51bGwsXG4gICAgICAgIGV4aXQ6IHR5cGVvZiBoYW5kbGVyLmV4aXQgPT09ICdmdW5jdGlvbicgPyBoYW5kbGVyLmV4aXQgOiBudWxsLFxuICAgICAgICBrZXlzOiBub3JtYWxpemVkS2V5cyxcbiAgICAgIH07XG4gICAgfSBlbHNlIGlmICh0eXBlb2YgaGFuZGxlciA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgbm9ybWFsaXplZFZpc2l0b3JbdHlwZV0gPSB7XG4gICAgICAgIGVudGVyOiBoYW5kbGVyLFxuICAgICAgICBleGl0OiBudWxsLFxuICAgICAgICBrZXlzOiBub3JtYWxpemVkS2V5cyxcbiAgICAgIH07XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIG5vcm1hbGl6ZWRWaXNpdG9yO1xufVxuIl19